<!DOCTYPE html>
<html lang="zh-CN" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文档阅读器 - 系统面板</title>
    <!-- 本地资源 -->
    <link href="/assets/css/tailwind.min.css" rel="stylesheet">
    <link href="/assets/css/font-awesome.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Noto+Sans+SC:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="/assets/js/jszip.min.js"></script>
    <script src="/assets/js/epub.min.js"></script>
    <link rel="icon" href="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NVRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNzU4NDQ1ODI1NTUwIiBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjU0MDM5IiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiPjxwYXRoIGQ9Ik00OCA4NzMuNmE0NjQgMTIxLjYgMCAxIDAgOTI4IDAgNDY0IDEyMS42IDAgMSAwLTkyOCAwWiIgZmlsbD0iI0RBRTlGRiIgcC1pZD0iNTQwNDAiPjwvcGF0aD48cGF0aCBkPSJNNzg0IDg1My42SDI0MGMtNTIuOCAwLTk2LTQzLjItOTYtOTZWMjEyLjhjMC01Mi44IDQzLjItOTYgOTYtOTZoNTQ0YzUyLjggMCA5NiA0My4yIDk2IDk2djU0NC44YzAgNTIuOC00My4yIDk2LTk2IDk2eiIgZmlsbD0iIzFEODVEQiIgcC1pZD0iNTQwNDEiPjwvcGF0aD48cGF0aCBkPSJNNzg0IDgyMC44SDI0MGMtNTIuOCAwLTk2LTQzLjItOTYtOTZWMTM0LjRjMC01Mi44IDQzLjItOTYgOTYtOTZoNTQ0YzUyLjggMCA5NiA0My4yIDk2IDk2djU4OS42YzAgNTMuNi00My4yIDk2LjgtOTYgOTYuOHoiIGZpbGw9IiM0NTlERjUiIHAtaWQ9IjU0MDQyIj48L3BhdGg+PHBhdGggZD0iTTc1MiAyNzJINDUyYy0xNi44IDAtMzAuNC0xMy42LTMwLjQtMzAuNHYtMjhjMC0xNi44IDEzLjYtMzAuNCAzMC40LTMwLjRINzUyYzE2LjggMCAzMC40IDEzLjYgMzAuNCAzMC40djI4Qzc4MS42IDI1OS4yIDc2OCAyNzIgNzUyIDI3MnoiIGZpbGw9IiNEQUU5RkYiIHAtaWQ9IjU0MDQzIj48L3BhdGg+PHBhdGggZD0iTTc0OCAyNjMuMkg0NDYuNGMtMTYuOCAwLTMwLjQtMTMuNi0zMC40LTMwLjR2LTI5LjZjMC0xNi44IDEzLjYtMzAuNCAzMC40LTMwLjRoMzAxLjZjMTYuOCAwIDMwLjQgMTMuNiAzMC40IDMwLjR2MjkuNmMtMC44IDE2LjgtMTMuNiAzMC40LTMwLjQgMzAuNHoiIGZpbGw9IiNGRkZGRkYiIHAtaWQ9IjU0MDQ0Ij48L3BhdGg+PHBhdGggZD0iTTc1MiA0NzkuMkg0NTJjLTE2LjggMC0zMC40LTEzLjYtMzAuNC0zMC40di0yOGMwLTE2LjggMTMuNi0zMC40IDMwLjQtMzAuNEg3NTJjMTYuOCAwIDMwLjQgMTMuNiAzMC40IDMwLjR2MjhjLTAuOCAxNi44LTE0LjQgMzAuNC0zMC40IDMwLjR6IiBmaWxsPSIjREFFOUZGIiBwLWlkPSI1NDA0NSI+PC9wYXRoPjxwYXRoIGQ9Ik03NDIuNCA0NjguOGgtMjk2Yy0xNi44IDAtMzAuNC0xMy42LTMwLjQtMzAuNHYtMjhjMC0xNi44IDEzLjYtMzAuNCAzMC40LTMwLjRoMjk2LjhjMTYuOCAwIDMwLjQgMTMuNiAzMC40IDMwLjR2MjhjLTAuOCAxNi44LTE0LjQgMzAuNC0zMS4yIDMwLjR6IiBmaWxsPSIjRkZGRkZGIiBwLWlkPSI1NDA0NiI+PC9wYXRoPjxwYXRoIGQ9Ik03NTIgNjg1LjZINDUyYy0xNi44IDAtMzAuNC0xMy42LTMwLjQtMzAuNHYtMjhjMC0xNi44IDEzLjYtMzAuNCAzMC40LTMwLjRINzUyYzE2LjggMCAzMC40IDEzLjYgMzAuNCAzMC40djI4Yy0wLjggMTYuOC0xNC40IDMwLjQtMzAuNCAzMC40eiIgZmlsbD0iI0RBRTlGRiIgcC1pZD0iNTQwNDciPjwvcGF0aD48cGF0aCBkPSJNNzQyLjQgNjc1LjJoLTI5NmMtMTYuOCAwLTMwLjQtMTMuNi0zMC40LTMwLjR2LTI4YzAtMTYuOCAxMy42LTMwLjQgMzAuNC0zMC40aDI5Ni44YzE2LjggMCAzMC40IDEzLjYgMzAuNCAzMC40djI4Yy0wLjggMTYuOC0xNC40IDMwLjQtMzEuMiAzMC40eiIgZmlsbD0iI0ZGRkZGRiIgcC1pZD0iNTQwNDgiPjwvcGF0aD48cGF0aCBkPSJNMzAyLjQgMjcyaC0zNC40Yy0xMy42IDAtMjQuOC0xMS4yLTI0LjgtMjQuOHYtMzguNGMwLTEzLjYgMTEuMi0yNC44IDI0LjgtMjQuOGgzNC40YzEzLjYgMCAyNC44IDExLjIgMjQuOCAyNC44djM4LjRjMCAxMy42LTExLjIgMjQuOC0yNC44IDI0Ljh6IiBmaWxsPSIjREFFOUZGIiBwLWlkPSI1NDA0OSI+PC9wYXRoPjxwYXRoIGQ9Ik0zMDEuNiAyNjMuMmgtMzQuNGMtMTMuNiAwLTI0LjgtMTEuMi0yNC44LTI0Ljh2LTQwYzAtMTMuNiAxMS4yLTI0LjggMjQuOC0yNC44aDM0LjRjMTMuNiAwIDI0LjggMTEuMiAyNC44IDI0Ljh2NDBjMCAxMy42LTExLjIgMjQuOC0yNC44IDI0Ljh6IiBmaWxsPSIjRkZGRkZGIiBwLWlkPSI1NDA1MCI+PC9wYXRoPjxwYXRoIGQ9Ik0zMDIuNCA0NzkuMmgtMzQuNGMtMTMuNiAwLTI0LjgtMTEuMi0yNC44LTI0LjhWNDE2YzAtMTMuNiAxMS4yLTI0LjggMjQuOC0yNC44aDM0LjRjMTMuNiAwIDI0LjggMTEuMiAyNC44IDI0Ljh2MzguNGMwIDEzLjYtMTEuMiAyNC44LTI0LjggMjQuOHoiIGZpbGw9IiNEQUU5RkYiIHAtaWQ9IjU0MDUxIj48L3BhdGg+PHBhdGggZD0iTTMwMC44IDQ2OC44aC0zMy42Yy0xMy42IDAtMjQuOC0xMS4yLTI0LjgtMjQuOHYtMzkuMmMwLTEzLjYgMTEuMi0yNC44IDI0LjgtMjQuOGgzMy42YzEzLjYgMCAyNC44IDExLjIgMjQuOCAyNC44djM5LjJjMCAxMy42LTExLjIgMjQuOC0yNC44IDI0Ljh6IiBmaWxsPSIjRkZGRkZGIiBwLWlkPSI1NDA1MiI+PC9wYXRoPjxwYXRoIGQ9Ik0zMDIuNCA2ODUuNmgtMzQuNGMtMTMuNiAwLTI0LjgtMTEuMi0yNC44LTI0Ljh2LTM4LjRjMC0xMy42IDExLjItMjQuOCAyNC44LTI0LjhoMzQuNGMxMy42IDAgMjQuOCAxMS4yIDI0LjggMjQuOHYzOC40YzAgMTMuNi0xMS4yIDI0LjgtMjQuOCAyNC44eiIgZmlsbD0iI0RBRTlGRiIgcC1pZD0iNTQwNTMiPjwvcGF0aD48cGF0aCBkPSJNMzAwLjggNjc1LjJoLTMzLjZjLTEzLjYgMC0yNC44LTExLjItMjQuOC0yNC44di0zOS4yYzAtMTMuNiAxMS4yLTI0LjggMjQuOC0yNC44aDMzLjZjMTMuNiAwIDI0LjggMTEuMiAyNC44IDI0Ljh2MzkuMmMwIDEzLjYtMTEuMiAyNC44LTI0LjggMjQuOHoiIGZpbGw9IiNGRkZGRkYiIHAtaWQ9IjU0MDU0Ij48L3BhdGg+PC9zdmc+" type="image/svg+xml">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36CFC9',
                        dark: {
                            100: '#1D2129',
                            200: '#141414',
                            300: '#0F0F0F'
                        },
                        light: {
                            100: '#F2F3F5',
                            200: '#E5E6EB',
                            300: '#C9CDD4'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        :root{
            --bg: #f7f7f8;
            --panel: #ffffff;
            --text: #222222;
            --ui-font: 'Inter', 'Noto Sans SC', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            --muted: #666666;
            --accent: #165DFF;
            --border: #eee;
            --control-bg: #f0f0f0;
            --shadow: rgba(0,0,0,0.08);
        }
        .dark{
            --bg: #0f1112;
            --panel: #1f1f22;
            --text: #ffffff;
            --muted: #aaaaaa;
            --accent: #165DFF;
            --border: #333333;
            --control-bg: #333333;
            --shadow: rgba(0,0,0,0.35);
        }
        body {
            font-family: var(--ui-font);
            margin: 0;
            padding: 0;
            background: var(--bg);
            color: var(--text);
        }
        .reader-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .reader-header {
            background: var(--panel);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }
        .reader-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text);
        }
        .reader-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        .epub-viewer {
            flex: 1;
            overflow: auto;
            padding: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .epub-container {
            width: 100%;
            max-width: clamp(320px, 72vw, 1000px);
            height: calc(100vh - 140px);
        }
        .epub-toc-sidebar {
            width: 300px;
            background: var(--panel);
            border-left: 1px solid var(--border);
            overflow-y: auto;
            padding: 1rem;
            display: none;
        }
        .epub-toc-sidebar.open {
            display: block;
        }
        .toc-title {
            font-weight: bold;
            margin-bottom: 1rem;
            color: var(--text);
        }
        .toc-list {
            list-style: none;
            padding: 0;
        }
        .toc-item {
            padding: 0.5rem 0;
            cursor: pointer;
            color: var(--muted);
            border-bottom: 1px solid var(--border);
        }
        .toc-item:hover {
            color: var(--accent);
        }
        .reader-footer {
            background: var(--panel);
            padding: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            border-top: 1px solid var(--border);
        }
        .nav-btn {
            background: var(--accent);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin: 0 0.5rem;
            font-size: 1.2rem;
        }
        .nav-btn:disabled {
            background: #999;
            cursor: not-allowed;
        }
        .font-controls {
            display: flex;
            align-items: center;
            margin: 0 1rem;
        }
        .font-btn {
            background: var(--control-bg);
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin: 0 0.25rem;
            color: var(--text);
        }
        .close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--panel);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 10px var(--shadow);
            z-index: 100;
        }
        .toc-toggle{
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 0.45rem 0.65rem;
            border-radius: 8px;
            display: inline-flex;
            gap: 0.5rem;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 6px 18px rgba(0,0,0,0.04);
        }
        .toc-toggle:hover{ transform: translateY(-1px); }
        /* 头部关闭按钮样式（替代全屏） */
        .header-close{
            background:var(--accent);color:#fff;border:none;padding:0.5rem 0.75rem;border-radius:8px;display:inline-flex;align-items:center;gap:0.5rem;cursor:pointer;font-weight:600;box-shadow:0 6px 18px rgba(22,93,255,0.12);
        }
        .header-close i{font-size:0.95rem}
        .header-close:hover{transform:translateY(-1px);box-shadow:0 10px 24px rgba(22,93,255,0.16)}
        .doc-viewer {
            width: 100%;
            height: calc(100vh - 120px);
            border: none;
        }
        .text-viewer {
            width: 100%;
            height: calc(100vh - 120px);
            padding: 2rem;
            overflow: auto;
            background: var(--panel);
            color: var(--text);
            font-family: var(--ui-font), monospace;
            border-radius: 6px;
        }
        /* 强制深色模式下文本视图内所有文字为白色，覆盖内联样式 */
        .dark .text-viewer, .dark .text-viewer * {
            color: #ffffff !important;
        }
        
        /* 移动端适配 */
        @media (max-width: 768px) {
            .reader-header {
                padding: 0.5rem;
            }
            .reader-title {
                font-size: 1rem;
            }
            .epub-container {
                padding: 1rem;
                height: calc(100vh - 120px);
            }
            .epub-toc-sidebar {
                width: 250px;
            }
            .reader-footer {
                padding: 0.5rem;
            }
            .nav-btn {
                width: 35px;
                height: 35px;
                margin: 0 0.25rem;
            }
            .font-controls {
                margin: 0 0.5rem;
            }
            .font-btn {
                width: 28px;
                height: 28px;
                margin: 0 0.15rem;
            }
            .close-btn {
                top: 0.5rem;
                right: 0.5rem;
                width: 35px;
                height: 35px;
            }
            .header-close{padding:0.4rem 0.6rem;font-size:0.92rem}
            /* 移动端：目录以覆盖层形式展示 */
            .epub-toc-sidebar{display:none;position:fixed;left:0;top:56px;bottom:0;width:84%;max-width:320px;z-index:1200;box-shadow:2px 0 18px rgba(0,0,0,0.2);background:var(--panel)}
            .epub-toc-sidebar.open{display:block}
            .doc-viewer, .text-viewer {
                height: calc(100vh - 100px);
            }
        }
    </style>
</head>
<body>
    <div class="reader-container">
        <div class="reader-header">
            <div class="reader-title" id="reader-title">文档阅读器</div>
            <div class="reader-actions">
                <button id="toc-toggle" class="toc-toggle">
                    <i class="fa fa-list"></i> 目录
                </button>
                <button id="header-close-btn" class="header-close">
                    <i class="fa fa-times"></i> 关闭
                </button>
            </div>
        </div>
        
        <div class="reader-content">
            <div class="epub-viewer" id="epub-viewer">
                <div class="epub-container" id="epub-container"></div>
            </div>
            
            <div class="epub-toc-sidebar" id="toc-sidebar">
                <div class="toc-title">目录</div>
                <ul class="toc-list" id="toc-list">
                    <!-- 目录将通过JavaScript动态添加 -->
                </ul>
            </div>
            
            <iframe class="doc-viewer" id="doc-viewer" style="display: none;"></iframe>
            <pre class="text-viewer" id="text-viewer" style="display: none;"></pre>
        </div>
        
        <div class="reader-footer">
            <button class="nav-btn" id="prev-btn">
                <i class="fa fa-arrow-left"></i>
            </button>
            
            <div class="font-controls">
                <button class="font-btn" id="font-decrease">
                    <i class="fa fa-font" style="font-size: 0.8rem;"></i>
                </button>
                <span id="current-page">1 / 1</span>
                <button class="font-btn" id="font-increase">
                    <i class="fa fa-font"></i>
                </button>
            </div>
            
            <button class="nav-btn" id="next-btn">
                <i class="fa fa-arrow-right"></i>
            </button>
        </div>
    </div>
    <script>
        // 主题初始化
        (function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
            } else if (savedTheme === 'light') {
                document.documentElement.classList.remove('dark');
            } else {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                }
            }
            window.addEventListener('themechange', (e) => {
                if (e.detail.theme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            });
        })();

        // 全局变量
        let authToken = localStorage.getItem('authToken') || null;
        let rendition = null;
        let book = null;
        let currentPage = 1;
        let totalPages = 1;

        // 从URL参数获取文件信息
        const urlParams = new URLSearchParams(window.location.search);
        const filePath = urlParams.get('path');
        let fileName = urlParams.get('name') || '文档';
        const fileType = urlParams.get('type') || 'document';
        const password = urlParams.get('password') || localStorage.getItem('authToken');

        if (!filePath || !password) {
            alert('缺少必要参数');
            history.back();
        } else {
            authToken = password;
            try { fileName = decodeURIComponent(fileName); } catch(e) {}
            document.getElementById('reader-title').textContent = fileName;
            document.title = fileName + ' - 文档阅读器';
            loadDocument();
        }

        // 加载文档
        async function loadDocument() {
            const ext = filePath.split('.').pop().toLowerCase();
            
            if (fileType === 'epub' || ext === 'epub') {
                loadEpub();
            } else if (ext === 'pdf') {
                loadPdf();
            } else if (ext === 'docx') {
                loadDocx();
            } else if (['txt', 'text', 'md', 'json', 'xml', 'csv', 'log', 'js', 'css', 'html', 'py', 'java', 'cpp', 'c', 'h', 'sql'].includes(ext)) {
                loadTextFile();
            } else {
                alert('不支持的文档格式');
            }
        }

        // 加载EPUB
        async function loadEpub() {
            document.getElementById('epub-viewer').style.display = 'flex';
            document.getElementById('doc-viewer').style.display = 'none';
            document.getElementById('text-viewer').style.display = 'none';
            
            const downloadUrl = `/api/cloud/download/${encodeURIComponent(filePath)}?password=${encodeURIComponent(authToken)}&inline=1`;
            
            try {
                const response = await fetch(downloadUrl);
                const arrayBuffer = await response.arrayBuffer();
                
                book = ePub(arrayBuffer);
                const isMobileFlow = window.innerWidth <= 768;
                rendition = book.renderTo('epub-container', {
                    width: '100%',
                    height: '100%',
                    flow: isMobileFlow ? 'scrolled' : 'paginated'
                });

                await rendition.display();

                // 在每个章节渲染后注入样式，确保在深色主题下正文文本可见并使用更好字体
                rendition.on('rendered', (section) => {
                    try {
                        const rootStyle = getComputedStyle(document.documentElement);
                        const panel = (rootStyle.getPropertyValue('--panel') || '').trim() || '#ffffff';
                        const isDark = document.documentElement.classList.contains('dark');
                        const textColor = isDark ? '#ffffff' : ((rootStyle.getPropertyValue('--text') || '').trim() || '#000000');
                        const uiFont = (rootStyle.getPropertyValue('--ui-font') || '').trim() || 'Inter, system-ui, Arial';
                        const accent = (rootStyle.getPropertyValue('--accent') || '').trim() || '#165DFF';
                        const css = `
                            html, body, p, h1, h2, h3, h4, h5, h6, li, span, div, a, code, pre, blockquote, td, th, strong, em {
                                background: ${panel} !important;
                                color: ${textColor} !important;
                                font-family: ${uiFont} !important;
                            }
                            img{max-width:100% !important; height:auto !important;}
                            a{color: ${accent} !important;}
                            pre, code { background: transparent !important; color: ${textColor} !important; }
                        `;
                        const doc = section.document;
                        if (doc && doc.head) {
                            let styleEl = doc.getElementById('injected-theme-style');
                            if (!styleEl) {
                                styleEl = doc.createElement('style');
                                styleEl.id = 'injected-theme-style';
                                doc.head.appendChild(styleEl);
                            }
                            styleEl.textContent = css;
                        }
                    } catch (e) { console.warn('theme inject error', e); }
                });
                
                // 获取总页数
                await book.ready;
                if (book.locations) {
                    await book.locations.generate();
                    totalPages = book.locations.length();
                }
                
                updatePageInfo();
                
                // 监听翻页事件
                rendition.on('relocated', (location) => {
                    currentPage = location.start.displayed.page;
                    if (totalPages === 1 && book.locations) {
                        totalPages = book.locations.length();
                    }
                    updatePageInfo();
                });
                
                // 加载目录
                loadToc();
            } catch (error) {
                console.error('加载EPUB失败:', error);
                alert('EPUB文件加载失败');
            }
        }

        // 加载PDF
        function loadPdf() {
            document.getElementById('epub-viewer').style.display = 'none';
            document.getElementById('doc-viewer').style.display = 'block';
            document.getElementById('text-viewer').style.display = 'none';
            
            const downloadUrl = `/api/cloud/download/${encodeURIComponent(filePath)}?password=${encodeURIComponent(authToken)}&inline=1`;
            document.getElementById('doc-viewer').src = downloadUrl;
        }

        // 加载Docx
        async function loadDocx() {
            document.getElementById('epub-viewer').style.display = 'none';
            document.getElementById('doc-viewer').style.display = 'block';
            document.getElementById('text-viewer').style.display = 'none';
            
            const previewUrl = `/api/cloud/preview?password=${encodeURIComponent(authToken)}&path=${encodeURIComponent(filePath)}`;
            
            try {
                const response = await fetch(previewUrl);
                const html = await response.text();
                
                // 创建一个临时的iframe来渲染HTML，使用当前主题的字体/颜色
                const iframe = document.getElementById('doc-viewer');
                const doc = iframe.contentDocument || iframe.contentWindow.document;
                const rootStyle = getComputedStyle(document.documentElement);
                const panel = (rootStyle.getPropertyValue('--panel') || '').trim() || '#ffffff';
                const isDark = document.documentElement.classList.contains('dark');
                const textColor = isDark ? '#ffffff' : ((rootStyle.getPropertyValue('--text') || '').trim() || '#000000');
                const uiFont = (rootStyle.getPropertyValue('--ui-font') || '').trim() || 'Inter, system-ui, Arial';
                doc.open();
                doc.write(`
                    <!DOCTYPE html>
                    <html>
                        <head>
                            <meta charset="utf-8">
                            <title>${fileName}</title>
                            <style>
                                html, body, p, h1, h2, h3, h4, h5, h6, li, span, div, a, code, pre, blockquote, td, th, strong, em {
                                    background: ${panel} !important;
                                    color: ${textColor} !important;
                                    font-family: ${uiFont} !important;
                                }
                                a{ color: ${rootStyle.getPropertyValue('--accent') || '#165DFF'} !important; }
                                img { max-width: 100%; height: auto; }
                                pre, code { background: transparent !important; color: ${textColor} !important; }
                            </style>
                        </head>
                        <body>${html}</body>
                    </html>
                `);
                doc.close();
            } catch (error) {
                console.error('加载Docx失败:', error);
                alert('Docx文件加载失败');
            }
        }

        // 加载文本文件
        async function loadTextFile() {
            document.getElementById('epub-viewer').style.display = 'none';
            document.getElementById('doc-viewer').style.display = 'none';
            document.getElementById('text-viewer').style.display = 'block';
            
            const downloadUrl = `/api/cloud/download/${encodeURIComponent(filePath)}?password=${encodeURIComponent(authToken)}&inline=1`;
            
            try {
                const response = await fetch(downloadUrl);
                const text = await response.text();
                document.getElementById('text-viewer').textContent = text;
            } catch (error) {
                console.error('加载文本文件失败:', error);
                alert('文本文件加载失败');
            }
        }

        // 加载目录
        async function loadToc() {
            if (!book) return;
            
            await book.ready;
            const toc = book.navigation ? book.navigation.toc : [];
            const tocList = document.getElementById('toc-list');
            tocList.innerHTML = '';
            
            toc.forEach(item => {
                const li = document.createElement('li');
                li.className = 'toc-item';
                li.textContent = item.label;
                li.addEventListener('click', () => {
                    rendition.display(item.href);
                    document.getElementById('toc-sidebar').classList.remove('open');
                });
                tocList.appendChild(li);
            });
        }

        // 更新页面信息
        function updatePageInfo() {
            document.getElementById('current-page').textContent = `${currentPage} / ${totalPages || '?'}`;
        }

        // 导航事件
        document.getElementById('prev-btn').addEventListener('click', () => {
            if (rendition) {
                rendition.prev();
            }
        });

        document.getElementById('next-btn').addEventListener('click', () => {
            if (rendition) {
                rendition.next();
            }
        });

        // 字体大小控制
        document.getElementById('font-increase').addEventListener('click', () => {
            if (rendition) {
                rendition.themes.fontSize('120%');
            }
        });

        document.getElementById('font-decrease').addEventListener('click', () => {
            if (rendition) {
                rendition.themes.fontSize('80%');
            }
        });

        // 目录开关
        document.getElementById('toc-toggle').addEventListener('click', () => {
            document.getElementById('toc-sidebar').classList.toggle('open');
        });

        // 通用关闭逻辑（用于头部和右下角关闭按钮）
        function closeViewer(){
            try{ if (rendition) { rendition.destroy(); } }catch(e){}
            if (window.history && window.history.length > 1) {
                window.history.back();
            } else if (window.opener) {
                // 如果是弹窗，则关闭
                window.close();
            } else {
                window.location.href = '/';
            }
        }

        // 头部关闭按钮
        const headerCloseBtn = document.getElementById('header-close-btn');
        if(headerCloseBtn){ headerCloseBtn.addEventListener('click', closeViewer); }

        // 右下角关闭按钮
        document.getElementById('close-btn').addEventListener('click', closeViewer);

        // 键盘快捷键
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') {
                document.getElementById('prev-btn').click();
            } else if (e.key === 'ArrowRight') {
                document.getElementById('next-btn').click();
            } else if (e.key === 'Escape') {
                document.getElementById('close-btn').click();
            }
        });
    </script>
</body>
</html>