<!DOCTYPE html>
<html lang="zh-CN" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>裂开の系统面板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNzU4NDQ1ODI1NTUwIiBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjU0MDM5IiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiPjxwYXRoIGQ9Ik00OCA4NzMuNmE0NjQgMTIxLjYgMCAxIDAgOTI4IDAgNDY0IDEyMS42IDAgMSAwLTkyOCAwWiIgZmlsbD0iI0RBRTlGRiIgcC1pZD0iNTQwNDAiPjwvcGF0aD48cGF0aCBkPSJNNzg0IDg1My42SDI0MGMtNTIuOCAwLTk2LTQzLjItOTYtOTZWMjEyLjhjMC01Mi44IDQzLjItOTYgOTYtOTZoNTQ0YzUyLjggMCA5NiA0My4yIDk2IDk2djU0NC44YzAgNTIuOC00My4yIDk2LTk2IDk2eiIgZmlsbD0iIzFEODVEQiIgcC1pZD0iNTQwNDEiPjwvcGF0aD48cGF0aCBkPSJNNzg0IDgyMC44SDI0MGMtNTIuOCAwLTk2LTQzLjItOTYtOTZWMTM0LjRjMC01Mi44IDQzLjItOTYgOTYtOTZoNTQ0YzUyLjggMCA5NiA0My4yIDk2IDk2djU4OS42YzAgNTMuNi00My4yIDk2LjgtOTYgOTYuOHoiIGZpbGw9IiM0NTlERjUiIHAtaWQ9IjU0MDQyIj48L3BhdGg+PHBhdGggZD0iTTc1MiAyNzJINDUyYy0xNi44IDAtMzAuNC0xMy42LTMwLjQtMzAuNHYtMjhjMC0xNi44IDEzLjYtMzAuNCAzMC40LTMwLjRINzUyYzE2LjggMCAzMC40IDEzLjYgMzAuNCAzMC40djI4Qzc4MS42IDI1OS4yIDc2OCAyNzIgNzUyIDI3MnoiIGZpbGw9IiNEQUU5RkYiIHAtaWQ9IjU0MDQzIj48L3BhdGg+PHBhdGggZD0iTTc0OCAyNjMuMkg0NDYuNGMtMTYuOCAwLTMwLjQtMTMuNi0zMC40LTMwLjR2LTI5LjZjMC0xNi44IDEzLjYtMzAuNCAzMC40LTMwLjRoMzAxLjZjMTYuOCAwIDMwLjQgMTMuNiAzMC40IDMwLjR2MjkuNmMtMC44IDE2LjgtMTMuNiAzMC40LTMwLjQgMzAuNHoiIGZpbGw9IiNGRkZGRkYiIHAtaWQ9IjU0MDQ0Ij48L3BhdGg+PHBhdGggZD0iTTc1MiA0NzkuMkg0NTJjLTE2LjggMC0zMC40LTEzLjYtMzAuNC0zMC40di0yOGMwLTE2LjggMTMuNi0zMC40IDMwLjQtMzAuNEg3NTJjMTYuOCAwIDMwLjQgMTMuNiAzMC40IDMwLjR2MjhjLTAuOCAxNi44LTE0LjQgMzAuNC0zMC40IDMwLjR6IiBmaWxsPSIjREFFOUZGIiBwLWlkPSI1NDA0NSI+PC9wYXRoPjxwYXRoIGQ9Ik03NDIuNCA0NjguOGgtMjk2Yy0xNi44IDAtMzAuNC0xMy42LTMwLjQtMzAuNHYtMjhjMC0xNi44IDEzLjYtMzAuNCAzMC40LTMwLjRoMjk2LjhjMTYuOCAwIDMwLjQgMTMuNiAzMC40IDMwLjR2MjhjLTAuOCAxNi44LTE0LjQgMzAuNC0zMS4yIDMwLjR6IiBmaWxsPSIjRkZGRkZGIiBwLWlkPSI1NDA0NiI+PC9wYXRoPjxwYXRoIGQ9Ik03NTIgNjg1LjZINDUyYy0xNi44IDAtMzAuNC0xMy42LTMwLjQtMzAuNHYtMjhjMC0xNi44IDEzLjYtMzAuNCAzMC40LTMwLjRINzUyYzE2LjggMCAzMC40IDEzLjYgMzAuNCAzMC40djI4Yy0wLjggMTYuOC0xNC40IDMwLjQtMzAuNCAzMC40eiIgZmlsbD0iI0RBRTlGRiIgcC1pZD0iNTQwNDciPjwvcGF0aD48cGF0aCBkPSJNNzQyLjQgNjc1LjJoLTI5NmMtMTYuOCAwLTMwLjQtMTMuNi0zMC40LTMwLjR2LTI4YzAtMTYuOCAxMy42LTMwLjQgMzAuNC0zMC40aDI5Ni44YzE2LjggMCAzMC40IDEzLjYgMzAuNCAzMC40djI4Yy0wLjggMTYuOC0xNC40IDMwLjQtMzEuMiAzMC40eiIgZmlsbD0iI0ZGRkZGRiIgcC1pZD0iNTQwNDgiPjwvcGF0aD48cGF0aCBkPSJNMzAyLjQgMjcyaC0zNC40Yy0xMy42IDAtMjQuOC0xMS4yLTI0LjgtMjQuOHYtMzguNGMwLTEzLjYgMTEuMi0yNC44IDI0LjgtMjQuOGgzNC40YzEzLjYgMCAyNC44IDExLjIgMjQuOCAyNC44djM4LjRjMCAxMy42LTExLjIgMjQuOC0yNC44IDI0Ljh6IiBmaWxsPSIjREFFOUZGIiBwLWlkPSI1NDA0OSI+PC9wYXRoPjxwYXRoIGQ9Ik0zMDEuNiAyNjMuMmgtMzQuNGMtMTMuNiAwLTI0LjgtMTEuMi0yNC44LTI0Ljh2LTQwYzAtMTMuNiAxMS4yLTI0LjggMjQuOC0yNC44aDM0LjRjMTMuNiAwIDI0LjggMTEuMiAyNC44IDI0Ljh2NDBjMCAxMy42LTExLjIgMjQuOC0yNC44IDI0Ljh6IiBmaWxsPSIjRkZGRkZGIiBwLWlkPSI1NDA1MCI+PC9wYXRoPjxwYXRoIGQ9Ik0zMDIuNCA0NzkuMmgtMzQuNGMtMTMuNiAwLTI0LjgtMTEuMi0yNC44LTI0LjhWNDE2YzAtMTMuNiAxMS4yLTI0LjggMjQuOC0yNC44aDM0LjRjMTMuNiAwIDI0LjggMTEuMiAyNC44IDI0Ljh2MzguNGMwIDEzLjYtMTEuMiAyNC44LTI0LjggMjQuOHoiIGZpbGw9IiNEQUU5RkYiIHAtaWQ9IjU0MDUxIj48L3BhdGg+PHBhdGggZD0iTTMwMC44IDQ2OC44aC0zMy42Yy0xMy42IDAtMjQuOC0xMS4yLTI0LjgtMjQuOHYtMzkuMmMwLTEzLjYgMTEuMi0yNC44IDI0LjgtMjQuOGgzMy42YzEzLjYgMCAyNC44IDExLjIgMjQuOCAyNC44djM5LjJjMCAxMy42LTExLjIgMjQuOC0yNC44IDI0Ljh6IiBmaWxsPSIjRkZGRkZGIiBwLWlkPSI1NDA1MiI+PC9wYXRoPjxwYXRoIGQ9Ik0zMDIuNCA2ODUuNmgtMzQuNGMtMTMuNiAwLTI0LjgtMTEuMi0yNC44LTI0Ljh2LTM4LjRjMC0xMy42IDExLjItMjQuOCAyNC44LTI0LjhoMzQuNGMxMy42IDAgMjQuOCAxMS4yIDI0LjggMjQuOHYzOC40YzAgMTMuNi0xMS4yIDI0LjgtMjQuOCAyNC44eiIgZmlsbD0iI0RBRTlGRiIgcC1pZD0iNTQwNTMiPjwvcGF0aD48cGF0aCBkPSJNMzAwLjggNjc1LjJoLTMzLjZjLTEzLjYgMC0yNC44LTExLjItMjQuOC0yNC44di0zOS4yYzAtMTMuNiAxMS4yLTI0LjggMjQuOC0yNC44aDMzLjZjMTMuNiAwIDI0LjggMTEuMiAyNC44IDI0Ljh2MzkuMmMwIDEzLjYtMTEuMiAyNC44LTI0LjggMjQuOHoiIGZpbGw9IiNGRkZGRkYiIHAtaWQ9IjU0MDU0Ij48L3BhdGg+PC9zdmc+" type="image/svg+xml">
    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36CFC9',
                        dark: {
                            100: '#1D2129',
                            200: '#141414',
                            300: '#0F0F0F'
                        },
                        light: {
                            100: '#F2F3F5',
                            200: '#E5E6EB',
                            300: '#C9CDD4'
                        }
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    boxShadow: {
                        'card': '0 4px 20px rgba(0, 0, 0, 0.08)',
                        'card-dark': '0 4px 20px rgba(0, 0, 0, 0.2)',
                        'hover': '0 8px 30px rgba(0, 0, 0, 0.12)'
                    }
                },
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .transition-all-300 {
                transition: all 300ms ease-in-out;
            }
            .card-hover {
                @apply transition-all-300 hover:shadow-hover hover:-translate-y-1;
            }
            .progress-bar {
                @apply h-2 rounded-full overflow-hidden bg-light-200 dark:bg-dark-100;
            }
            .progress-fill {
                @apply h-full transition-all-300;
            }
            .btn {
                @apply inline-flex items-center justify-center h-10 px-4 rounded-lg font-medium gap-2 transition-all-300 focus:outline-none focus:ring-2 focus:ring-offset-2;
            }
            .btn-primary {
                @apply btn bg-primary text-white hover:bg-primary/90 focus:ring-primary focus:ring-offset-dark-200 dark:focus:ring-offset-dark-300;
            }
            .btn-danger {
                @apply btn bg-red-500 text-white hover:bg-red-600 focus:ring-red-500 focus:ring-offset-dark-200 dark:focus:ring-offset-dark-300;
            }
            .btn-outline {
                @apply btn border border-light-200 dark:border-dark-100 hover:bg-light-100 dark:hover:bg-dark-100 focus:ring-primary focus:ring-offset-dark-200 dark:focus:ring-offset-dark-300;
            }
            /* 强制按钮内图标尺寸与垂直居中，避免不同字体或图标类导致高度差异 */
            .btn i,
            .btn .fa {
                font-size: 1rem; /* 等同于 text-base */
                line-height: 1;
                display: inline-flex;
                align-items: center;
                justify-content: center;
            }
            /* 小图标按钮（圆形），用于顶部工具栏等只含图标的交互 */
            .icon-btn {
                @apply inline-flex items-center justify-center w-10 h-10 p-2 rounded-full transition-all-300;
            }
            /* 小号按钮（紧凑型），用于在需要更窄高度的场景 */
            .btn-sm {
                @apply h-8 px-3 text-sm;
            }
            .icon-btn-sm {
                @apply inline-flex items-center justify-center w-8 h-8 p-1 rounded transition-all-300;
            }
            .input {
                @apply w-full px-4 py-2 rounded-lg border border-light-200 dark:border-dark-100 bg-white dark:bg-dark-100 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-300;
            }
            /* 文件列表项与图标：采用灵活的基础样式，具体布局由响应式规则决定（详见下面的全局样式） */
            .file-item {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 10px 12px;
                border-radius: 8px;
                transition: background-color .16s ease, box-shadow .16s ease, transform .12s ease;
                cursor: pointer;
            }

            /* 默认较小的图标容器，实际尺寸在媒体查询中调整 */
            .icon-container {
                width: 64px;
                height: 64px;
                flex-shrink: 0;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                border-radius: 6px;
                overflow: hidden;
                background: rgba(0,0,0,0.03);
            }

            /* 放大图标内的字体图标，保持垂直居中 */
            .icon-container .fa {
                font-size: 1.6rem;
                line-height: 1;
                display: inline-flex;
                align-items: center;
                justify-content: center;
            }

            /* 复选框：保持语义化和可访问性，视觉部分为 .custom-checkbox-box */
            .custom-checkbox {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                width: 24px;
                height: 24px;
                flex-shrink: 0;
            }
            .custom-checkbox-input {
                position: absolute !important;
                opacity: 0 !important;
                width: 1px !important;
                height: 1px !important;
                overflow: hidden !important;
                clip: rect(1px, 1px, 1px, 1px) !important;
                white-space: nowrap !important;
            }
            .custom-checkbox-box {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                width: 20px;
                height: 20px;
                border-radius: 4px;
                border: 1px solid rgba(0,0,0,0.08);
                background: rgba(255,255,255,0.98);
                transition: background .12s ease, border-color .12s ease;
            }
            .custom-checkbox-box i { font-size: 12px; line-height: 1; }
            .custom-checkbox-input:checked + .custom-checkbox-box {
                background: linear-gradient(180deg, rgba(59,130,246,1), rgba(37,99,235,1));
                border-color: rgba(37,99,235,1);
                color: white;
            }
            .custom-checkbox-box i { display: none; }
            .custom-checkbox-input:checked + .custom-checkbox-box i { display: inline-block; }
        }
    </style>
    <style>
        /* 响应式文件项与图标：防止在小屏设备中图标或缩略图变形 */
        .icon-container {
            width: 64px; /* 默认放大为 64px */
            height: 64px;
            flex-shrink: 0;
        }
        .file-item img.icon-thumb {
            width: 100%;
            height: 100%;
            object-fit: cover; /* 保持比例并裁剪，避免拉伸 */
            border-radius: 6px;
        }

        @media (max-width: 640px) {
            /* 小屏设备：保持行式列表（非竖版卡片），文件信息根据可用宽度自适应 */
            #file-list {
                display: block !important;
            }
            .file-item {
                flex-direction: row;
                gap: 10px;
                align-items: center;
                padding: 10px;
            }
            .icon-container { width: 56px; height: 56px; }
            .actions { gap: 6px; }
            /* 文件名在小屏允许最多两行，防止截断过短 */
            .file-item .font-medium {
                display: -webkit-box;
                -webkit-box-orient: vertical;
                -webkit-line-clamp: 2; /* Safari/Chrome */
                line-clamp: 2; /* 标准属性，用于部分工具链兼容 */
                overflow: hidden;
            }
            .file-item .text-xs { font-size: 12px; }
        }
        /* 防止 JS 执行前模态闪现：在渲染阶段隐藏重要模态，JS 将负责在需要时显示。
           注意：不要使用 !important，因为 JS 通过设置 inline style 来显示（inline style 优先级高于普通样式，但低于带 !important 的样式）。 */
        #auth-modal, #create-folder-modal, #delete-modal, #upload-modal, #rename-modal {
            display: none;
        }
        /* 批量选择样式：改为 inline 布局，始终显示在文件项最左侧（在 icon 之前） */
        .select-checkbox {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            margin-right: 6px;
            flex-shrink: 0;
            z-index: 2;
        }
        /* 缩略图保持方形并避免拉伸 */
        .file-item img.icon-thumb {
            width: 64px;
            height: 64px;
            object-fit: cover;
            border-radius: 6px;
        }
        .file-item {
            position: relative;
        }
        .file-item.selected {
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
            background-color: rgba(22,93,255,0.06);
            outline: 2px solid rgba(22,93,255,0.12);
        }
        .selection-toolbar {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            bottom: 18px;
            z-index: 60;
            display: none;
            gap: 8px;
        }
    </style>
    <!-- epub.js for EPUB rendering in preview -->
    <!-- JSZip is required by epub.js when passing ArrayBuffer/Blob input; load it first -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
</head>
<body class="font-inter bg-white dark:bg-dark-300 text-gray-800 dark:text-gray-200 min-h-screen flex flex-col transition-all-300">
    <!-- 顶部导航 -->
    <header class="sticky top-0 z-50 bg-white/90 dark:bg-dark-200/90 backdrop-blur-md border-b border-light-200 dark:border-dark-100 transition-all-300">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fa fa-server text-primary text-xl"></i>
                <h1 class="text-xl font-bold">裂开の系统面板</h1>
            </div>
            
            <div class="flex items-center gap-4">
                <!-- 主题切换按钮 -->
                <button id="theme-toggle" class="icon-btn hover:bg-light-100 dark:hover:bg-dark-100" aria-label="切换主题">
                    <i class="fa fa-moon-o dark:hidden text-gray-600"></i>
                    <i class="fa fa-sun-o hidden dark:block text-yellow-400"></i>
                </button>
                
                <!-- 密码验证状态 -->
                <div id="auth-status" class="hidden items-center gap-2">
                    <span class="text-sm text-green-500">
                        <i class="fa fa-lock-open"></i> 已验证
                    </span>
                    <button id="logout-btn" class="text-sm text-gray-500 hover:text-red-500 transition-all-300">
                        退出
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="flex-grow container mx-auto px-4 py-6">
    <!-- 密码验证模态框 -->
    <div id="auth-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" style="display: none;">
            <div class="bg-white dark:bg-dark-200 rounded-xl shadow-card dark:shadow-card-dark w-full max-w-md p-6 transform transition-all-300">
                <h2 class="text-xl font-bold mb-4 text-center">身份验证</h2>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-6 text-center">请输入管理员密码以访问系统功能</p>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1" for="password">管理员密码</label>
                        <input type="password" id="password" class="input" placeholder="请输入密码">
                    </div>
                    
                    <div class="flex gap-3">
                        <button id="auth-btn" class="btn-primary flex-1">验证</button>
                        <button id="cancel-auth-btn" class="btn-outline flex-1">取消</button>
                    </div>
                    
                    <p id="auth-error" class="hidden text-sm text-red-500 text-center mt-2">密码错误，请重试</p>
                </div>
            </div>
        </div>

        <!-- 页面顶部不再显示系统状态卡片，已移入“系统控制”标签页 -->

        <!-- 功能标签页 -->
        <div class="bg-white dark:bg-dark-200 rounded-xl shadow-card dark:shadow-card-dark overflow-hidden mb-8">
            <!-- 标签页导航 -->
            <div class="border-b border-light-200 dark:border-dark-100 flex flex-wrap">
                <button class="tab-btn active px-6 py-4 font-medium transition-all-300 border-b-2 border-primary text-primary" data-tab="system-control">
                    系统控制
                </button>
                <button class="tab-btn px-6 py-4 font-medium transition-all-300 border-b-2 border-transparent hover:text-primary dark:hover:text-primary" data-tab="cloud-storage">
                    网盘存储
                </button>
            </div>

            <!-- 系统控制标签页 -->
            <div class="tab-content active p-6" id="system-control">
                <h2 class="text-xl font-bold mb-6">系统控制</h2>

                <!-- CPU/内存 卡片 -->
                <section id="system-status-in-control" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white dark:bg-dark-200 rounded-xl shadow-card dark:shadow-card-dark p-6 card-hover">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-lg font-semibold">CPU 使用率</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">实时负载</p>
                            </div>
                            <div class="p-3 rounded-full bg-primary/10 dark:bg-primary/20 text-primary">
                                <i class="fa fa-microchip text-xl"></i>
                            </div>
                        </div>
                        <div class="flex items-end justify-between mb-2">
                            <span id="cpu-usage" class="text-3xl font-bold">0</span>
                            <span class="text-sm text-gray-500 dark:text-gray-400">%</span>
                        </div>
                        <div class="progress-bar">
                            <div id="cpu-progress" class="progress-fill bg-primary" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-dark-200 rounded-xl shadow-card dark:shadow-card-dark p-6 card-hover">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-lg font-semibold">内存使用率</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">物理内存</p>
                            </div>
                            <div class="p-3 rounded-full bg-secondary/10 dark:bg-secondary/20 text-secondary">
                                <i class="fa fa-tachometer text-xl"></i>
                            </div>
                        </div>
                        <div class="flex items-end justify-between mb-2">
                            <span id="mem-usage" class="text-3xl font-bold">0</span>
                            <span class="text-sm text-gray-500 dark:text-gray-400">%</span>
                        </div>
                        <div class="progress-bar">
                            <div id="mem-progress" class="progress-fill bg-secondary" style="width: 0%"></div>
                        </div>
                    </div>
                </section>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- 关机按钮 -->
                    <div class="bg-white dark:bg-dark-200 rounded-xl shadow-card dark:shadow-card-dark p-6 border border-red-100 dark:border-red-900/30 card-hover">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-lg font-semibold">关机</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">安全关闭系统</p>
                            </div>
                            <div class="p-3 rounded-full bg-red-100 dark:bg-red-900/20 text-red-500">
                                <i class="fa fa-power-off text-xl"></i>
                            </div>
                        </div>
                        <button id="shutdown-btn" class="btn w-full mt-4 border-red-500 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 focus:ring-red-500">
                            <i class="fa fa-power-off mr-2"></i> 关机
                        </button>
                    </div>

                    <!-- 重启按钮 -->
                    <div class="bg-white dark:bg-dark-200 rounded-xl shadow-card dark:shadow-card-dark p-6 border border-yellow-100 dark:border-yellow-900/30 card-hover">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-lg font-semibold">重启</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">重启系统</p>
                            </div>
                            <div class="p-3 rounded-full bg-yellow-100 dark:bg-yellow-900/20 text-yellow-500">
                                <i class="fa fa-refresh text-xl"></i>
                            </div>
                        </div>
                        <button id="restart-btn" class="btn w-full mt-4 border-yellow-500 text-yellow-500 hover:bg-yellow-50 dark:hover:bg-yellow-900/20 focus:ring-yellow-500">
                            <i class="fa fa-refresh mr-2"></i> 重启
                        </button>
                    </div>

                    <!-- 睡眠按钮 -->
                    <div class="bg-white dark:bg-dark-200 rounded-xl shadow-card dark:shadow-card-dark p-6 border border-blue-100 dark:border-blue-900/30 card-hover">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-lg font-semibold">睡眠</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">将系统置于休眠状态</p>
                            </div>
                            <div class="p-3 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-500">
                                <i class="fa fa-moon-o text-xl"></i>
                            </div>
                        </div>
                        <button id="sleep-btn" class="btn w-full mt-4 border-blue-500 text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 focus:ring-blue-500">
                            <i class="fa fa-moon-o mr-2"></i> 执行睡眠
                        </button>
                    </div>
                </div>

                <!-- 操作结果提示 -->
                <div id="system-result" class="hidden mt-6 p-4 rounded-lg bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 text-green-700 dark:text-green-300">
                    <div class="flex items-center">
                        <i class="fa fa-check-circle mr-2"></i>
                        <span id="system-result-text">操作成功</span>
                    </div>
                </div>
            </div>

            <!-- 网盘存储标签页 -->
            <div class="tab-content hidden p-6" id="cloud-storage">
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
                    <div>
                        <h2 class="text-xl font-bold">网盘</h2>
                    </div>
                    
                    <div class="flex-1 md:flex-none mt-3 md:mt-0">
                        <div class="relative">
                            <!-- 减小右侧内边距以适配两个右侧按钮（清除 + 搜索） -->
                            <input id="cloud-search" class="input pr-24" type="search" placeholder="搜索文件名">
                            <!-- 将清除按钮移至搜索按钮左侧，避免与其重叠 -->
                            <button id="clear-search" class="icon-btn-sm absolute right-20 top-1/2 -translate-y-1/2 text-gray-400 hidden" title="清除搜索"><i class="fa fa-times"></i></button>
                            <button id="do-search" class="btn btn-primary btn-sm absolute right-2 top-1/2 -translate-y-1/2">搜索</button>
                        </div>
                        <div class="mt-2 flex gap-2 flex-wrap" id="filter-buttons">
                            <button class="btn btn-outline btn-sm filter-btn" data-type="image">图片</button>
                            <button class="btn btn-outline btn-sm filter-btn" data-type="video">视频</button>
                            <button class="btn btn-outline btn-sm filter-btn" data-type="audio">音频</button>
                            <button class="btn btn-outline btn-sm filter-btn" data-type="text">文本</button>
                            <button class="btn btn-outline btn-sm filter-btn" data-type="doc">文档</button>
                        </div>
                    </div>

                    <div class="flex gap-3 md:ml-4">
                        <!-- 创建文件夹按钮 -->
                        <button id="create-folder-btn" class="btn btn-outline flex items-center">
                            <i class="fa fa-folder mr-2"></i> 新建文件夹
                        </button>
                        
                        <!-- 上传文件按钮 -->
                        <label class="btn btn-primary flex items-center cursor-pointer">
                            <i class="fa fa-upload mr-2"></i> 上传文件
                            <input type="file" id="file-upload" class="hidden" multiple>
                        </label>
                        
                        <!-- 多选按钮已移除：使用每项复选框触发多选模式 -->
                    </div>
                </div>
                
                <!-- 路径导航 -->
                <div id="path-container" class="flex items-center gap-2 mb-6 text-sm">
                    <!-- 根目录项（固定） -->
                    <a href="#" class="path-item cursor-pointer" data-path="">
                        <i class="fa fa-home mr-1"></i> 根目录
                    </a>
                    <!-- 返回上级（三个点）按钮 -->
                    <button id="go-up-btn" class="icon-btn-sm ml-2 text-gray-600 hover:text-gray-800" title="返回上级">…</button>
                    <!-- 动态路径项和分隔符将在这里生成 -->
                    <span id="dynamic-path-container"></span>
                </div>
                
                <!-- 网盘内容区 -->
                <div class="bg-light-100 dark:bg-dark-100 rounded-lg p-4 min-h-[400px]">
                    <!-- 加载状态 -->
                    <div id="cloud-loading" class="flex flex-col items-center justify-center h-[400px]">
                        <div class="fa fa-circle-o-notch fa-spin text-primary text-3xl mb-4"></div>
                        <p class="text-gray-500 dark:text-gray-400">加载文件列表中...</p>
                    </div>
                    
                    <!-- 空状态 -->
                    <div id="cloud-empty" class="hidden flex flex-col items-center justify-center h-[400px]">
                        <div class="fa fa-folder-open text-gray-300 dark:text-gray-600 text-6xl mb-4"></div>
                        <p class="text-gray-500 dark:text-gray-400 text-lg">当前目录为空</p>
                        <p class="text-sm text-gray-400 dark:text-gray-500 mt-2">点击上传文件或创建文件夹</p>
                    </div>
                    
                    <!-- 文件列表（改为正式列表样式） -->
                    <div id="file-list" class="hidden w-full divide-y divide-light-200 dark:divide-dark-100">
                        <!-- 文件项将通过JS动态生成（逐行展示） -->
                    </div>
                </div>
                
                <!-- 操作结果提示 -->
                <div id="cloud-result" class="hidden mt-4 p-4 rounded-lg bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 text-green-700 dark:text-green-300">
                    <div class="flex items-center">
                        <i class="fa fa-check-circle mr-2"></i>
                        <span id="cloud-result-text">操作成功</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-white dark:bg-dark-200 border-t border-light-200 dark:border-dark-100 py-4 mt-8">
        <div class="container mx-auto px-4 text-center text-sm text-gray-500 dark:text-gray-400">
            <p>裂开·托尔斯泰 の 系统控制面板 &copy;  2025</p>
        </div>
    </footer>

    <!-- 创建文件夹模态框 -->
    <div id="create-folder-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white dark:bg-dark-200 rounded-xl shadow-card dark:shadow-card-dark w-full max-w-md p-6 transform transition-all-300">
            <h2 class="text-xl font-bold mb-4">创建文件夹</h2>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">在当前目录下创建新文件夹</p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1" for="folder-name">文件夹名称</label>
                    <input type="text" id="folder-name" class="input" placeholder="请输入文件夹名称">
                </div>
                
                <div class="flex gap-3">
                    <button id="confirm-folder-btn" class="btn-primary flex-1">创建</button>
                    <button id="cancel-folder-btn" class="btn-outline flex-1">取消</button>
                </div>
                
                <p id="folder-error" class="hidden text-sm text-red-500 text-center mt-2">请输入有效的文件夹名称</p>
            </div>
        </div>
    </div>

    <!-- 批量操作工具栏 -->
    <div id="selection-toolbar" class="selection-toolbar">
        <button id="select-cancel" class="btn btn-outline">取消</button>
        <button id="select-delete" class="btn btn-danger">删除</button>
        <button id="select-move" class="btn btn-primary">移动到...</button>
    </div>

    <!-- 批量移动操作不使用输入模态，用户需在目标目录下点击“移动到此处” -->

    <!-- 删除确认模态框 -->
    <div id="delete-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white dark:bg-dark-200 rounded-xl shadow-card dark:shadow-card-dark w-full max-w-md p-6 transform transition-all-300">
            <h2 class="text-xl font-bold mb-2">确认删除</h2>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">你确定要删除 <span id="delete-item-name" class="font-medium text-red-500"></span> 吗？此操作不可撤销。</p>
            
            <div class="flex gap-3">
                <button id="confirm-delete-btn" class="btn-danger flex-1">确认删除</button>
                <button id="cancel-delete-btn" class="btn-outline flex-1">取消</button>
            </div>
            
            <input type="hidden" id="delete-item-path">
        </div>
    </div>

    <!-- 上传进度模态框 -->
    <div id="upload-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white dark:bg-dark-200 rounded-xl shadow-card dark:shadow-card-dark w-full max-w-md p-6 transform transition-all-300">
            <h2 class="text-xl font-bold mb-4">文件上传中</h2>
            
            <div class="space-y-4">
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-1" id="upload-filename">正在上传: 文件名</p>
                    <div class="progress-bar">
                        <div id="upload-progress" class="progress-fill bg-primary" style="width: 0%"></div>
                    </div>
                    <p class="text-sm text-right mt-1" id="upload-percentage">0%</p>
                        <p class="text-sm text-right mt-1 text-gray-500" id="upload-speed">速率: 0 KB/s</p>
                </div>
                
                <button id="cancel-upload-btn" class="btn-outline w-full">取消上传</button>
            </div>
        </div>
    </div>

        <!-- 预览模态框（用于图片/视频/音频/文本预览） -->
        <div id="preview-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm">
            <div id="preview-container" class="bg-white dark:bg-dark-200 rounded-xl shadow-card dark:shadow-card-dark w-full max-w-6xl p-4 transform transition-all-300">
                <div class="flex justify-between items-center mb-3">
                    <h3 id="preview-title" class="text-lg font-semibold">预览</h3>
                    <div class="flex items-center gap-2">
                        <!-- 放大/全屏按钮（默认隐藏，脚本按需显示） -->
                        <button id="preview-large" class="icon-btn hidden" aria-label="放大预览"><i class="fa fa-arrows-alt"></i></button>
                        <button id="preview-close" class="icon-btn" aria-label="关闭预览"><i class="fa fa-close"></i></button>
                    </div>
                </div>

                <!-- 预览工具栏（EPUB 特有控件：翻页/跳转） - 初始隐藏，由脚本按需填充并显示 -->
                <div id="preview-toolbar" class="hidden mb-3"></div>

                <div id="preview-content" class="max-h-[80vh] min-h-[180px] overflow-auto flex items-center justify-center relative">
                    <div id="preview-spinner" class="absolute inset-0 flex items-center justify-center bg-black/20 hidden">
                        <i class="fa fa-circle-o-notch fa-spin text-3xl text-white"></i>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // 全局变量
            let authToken = localStorage.getItem('authToken') || null;
            let currentCloudPath = '';
        let uploadXHR = null;
        let uploadState = null; // { startTime, lastLoaded, lastTime }

        // 路径规范化工具：统一为不带首尾斜杠的以正斜杠分隔的路径（空字符串表示根目录）
        function normalizePath(p) {
            if (!p) return '';
            let s = String(p).replace(/\\/g, '/');
            // 去除首尾多余斜杠并压缩多余的空段
            s = s.replace(/^\/+|\/+$/g, '').split('/').filter(Boolean).join('/');
            return s;
        }

        // DOM 元素
        const elements = {
            // 主题相关
            themeToggle: document.getElementById('theme-toggle'),
            html: document.documentElement,
            
            // 身份验证相关
            authModal: document.getElementById('auth-modal'),
            passwordInput: document.getElementById('password'),
            authBtn: document.getElementById('auth-btn'),
            cancelAuthBtn: document.getElementById('cancel-auth-btn'),
            authError: document.getElementById('auth-error'),
            authStatus: document.getElementById('auth-status'),
            logoutBtn: document.getElementById('logout-btn'),
            
            // 系统状态相关（移除系统信息相关元素）
            cpuUsage: document.getElementById('cpu-usage'),
            cpuProgress: document.getElementById('cpu-progress'),
            memUsage: document.getElementById('mem-usage'),
            memProgress: document.getElementById('mem-progress'),
            
            // 系统控制相关
            shutdownBtn: document.getElementById('shutdown-btn'),
            restartBtn: document.getElementById('restart-btn'),
            sleepBtn: document.getElementById('sleep-btn'),
            systemResult: document.getElementById('system-result'),
            systemResultText: document.getElementById('system-result-text'),
            
            // 标签页相关
            tabBtns: document.querySelectorAll('.tab-btn'),
            tabContents: document.querySelectorAll('.tab-content'),
            
            // 网盘相关
            cloudTab: document.getElementById('cloud-storage'),
            createFolderBtn: document.getElementById('create-folder-btn'),
            searchInput: document.getElementById('cloud-search'),
            doSearchBtn: document.getElementById('do-search'),
            clearSearchBtn: document.getElementById('clear-search'),
            filterButtonsContainer: document.getElementById('filter-buttons'),
            fileUpload: document.getElementById('file-upload'),
            pathContainer: document.getElementById('path-container'),
            dynamicPathContainer: document.getElementById('dynamic-path-container'),
            pathItems: document.querySelectorAll('.path-item'),
            cloudLoading: document.getElementById('cloud-loading'),
            cloudEmpty: document.getElementById('cloud-empty'),
            fileList: document.getElementById('file-list'),
            cloudResult: document.getElementById('cloud-result'),
            cloudResultText: document.getElementById('cloud-result-text'),
            
            // 创建文件夹模态框
            createFolderModal: document.getElementById('create-folder-modal'),
            folderNameInput: document.getElementById('folder-name'),
            confirmFolderBtn: document.getElementById('confirm-folder-btn'),
            cancelFolderBtn: document.getElementById('cancel-folder-btn'),
            folderError: document.getElementById('folder-error'),
            
            // 删除模态框
            deleteModal: document.getElementById('delete-modal'),
            deleteItemName: document.getElementById('delete-item-name'),
            deleteItemPath: document.getElementById('delete-item-path'),
            confirmDeleteBtn: document.getElementById('confirm-delete-btn'),
            cancelDeleteBtn: document.getElementById('cancel-delete-btn'),
            
            // 上传模态框
            uploadModal: document.getElementById('upload-modal'),
            uploadFilename: document.getElementById('upload-filename'),
            uploadProgress: document.getElementById('upload-progress'),
            uploadPercentage: document.getElementById('upload-percentage'),
            uploadSpeed: document.getElementById('upload-speed'),
            cancelUploadBtn: document.getElementById('cancel-upload-btn')
            ,
            // 重命名模态相关元素（在 DOM 中稍后添加）
            renameModal: document.getElementById('rename-modal'),
            renameInput: document.getElementById('rename-input'),
            confirmRenameBtn: document.getElementById('confirm-rename-btn'),
            cancelRenameBtn: document.getElementById('cancel-rename-btn'),
            renameOldPath: document.getElementById('rename-old-path')
        };

        // 初始化
        function init() {
            // 主题初始化
            initTheme();

            // 事件监听
            addEventListeners();

            // 恢复认证状态：如果 localStorage 中有 isAuthenticated 标记且有 authToken，则直接恢复
            const stored = localStorage.getItem('authToken');
            const wasAuthenticated = localStorage.getItem('isAuthenticated') === '1';

            if (stored && wasAuthenticated) {
                // 恢复会话，不再强制在每次刷新时向后端验证
                authToken = stored;
                updateAuthStatus(true);

                // 加载系统状态和网盘内容
                loadSystemStatus();
                setInterval(loadSystemStatus, 5000);
                loadCloudFiles();
                // 隐藏认证模态（防止留在页面上）
                hideAuthModal();
            } else if (stored) {
                // 有存储的密码但未标记为已验证，尝试一次性验证（兼容旧会话）
                checkAuthStatus();
            } else {
                // 未保存密码，显示认证模态框
                showAuthModal();
            }
        }

        // 主题初始化
        function initTheme() {
            // 从 localStorage 读取主题偏好，没有则根据系统偏好设置
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                elements.html.classList.add('dark');
            } else if (savedTheme === 'light') {
                elements.html.classList.remove('dark');
            } else {
                // 根据系统偏好设置
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    elements.html.classList.add('dark');
                }
            }
        }

        // 事件监听
        function addEventListeners() {
            // 主题切换
            elements.themeToggle.addEventListener('click', toggleTheme);
            
            // 身份验证相关
            elements.authBtn.addEventListener('click', handleAuth);
            elements.cancelAuthBtn.addEventListener('click', hideAuthModal);
            elements.logoutBtn.addEventListener('click', handleLogout);
            elements.passwordInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') handleAuth();
            });
            
            // 系统控制相关
            elements.shutdownBtn.addEventListener('click', () => executeSystemCommand('shutdown'));
            elements.restartBtn.addEventListener('click', () => executeSystemCommand('restart'));
            elements.sleepBtn.addEventListener('click', () => executeSystemCommand('sleep'));
            
            // 标签页切换
            elements.tabBtns.forEach(btn => {
                btn.addEventListener('click', () => switchTab(btn.dataset.tab));
            });
            
            // 网盘相关
            elements.createFolderBtn.addEventListener('click', showCreateFolderModal);
            elements.fileUpload.addEventListener('change', handleFileUpload);
            if (elements.doSearchBtn) elements.doSearchBtn.addEventListener('click', () => performSearch(elements.searchInput.value));
            if (elements.searchInput) elements.searchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') performSearch(elements.searchInput.value); });
            if (elements.clearSearchBtn) elements.clearSearchBtn.addEventListener('click', () => { elements.searchInput.value = ''; elements.clearSearchBtn.classList.add('hidden'); loadCloudFiles(); });
            if (elements.filterButtonsContainer) elements.filterButtonsContainer.addEventListener('click', (e) => {
                const btn = e.target.closest('.filter-btn');
                if (!btn) return;
                btn.classList.toggle('bg-primary');
                btn.classList.toggle('text-white');
                // 执行搜索以应用筛选
                performSearch(elements.searchInput.value);
            });
            // 返回上级按钮（可能动态隐藏）
            const goUpBtn = document.getElementById('go-up-btn');
            if (goUpBtn) goUpBtn.addEventListener('click', (e) => { e.preventDefault(); goUpOneLevel(); });
            
            // 初始根目录路径点击事件
            document.querySelector('.path-item[data-path=""]').addEventListener('click', (e) => {
                e.preventDefault();
                navigateToPath('');
            });
            
            // 创建文件夹模态框
            elements.confirmFolderBtn.addEventListener('click', createFolder);
            elements.cancelFolderBtn.addEventListener('click', hideCreateFolderModal);
            elements.folderNameInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') createFolder();
            });
            
            // 删除模态框
            elements.confirmDeleteBtn.addEventListener('click', deleteItem);
            elements.cancelDeleteBtn.addEventListener('click', hideDeleteModal);
            
            // 上传模态框
            elements.cancelUploadBtn.addEventListener('click', cancelUpload);
        }

        // 返回上一级目录
        function goUpOneLevel() {
            const norm = normalizePath(currentCloudPath);
            if (!norm) return; // 已在根目录
            const idx = norm.lastIndexOf('/');
            const parent = idx > 0 ? norm.substring(0, idx) : '';
            navigateToPath(parent);
        }

        // 主题切换
        function toggleTheme() {
            if (elements.html.classList.contains('dark')) {
                elements.html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                elements.html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
        }

        // 显示认证模态框
        function showAuthModal() {
            if (!elements.authModal) return;
            // 确保任何可能的隐藏类被移除，并设置 inline style
            elements.authModal.classList.remove('hidden');
            elements.authModal.style.display = 'flex';
            elements.passwordInput.value = '';
            elements.authError.classList.add('hidden');
            // 延迟聚焦以确保元素已渲染
            requestAnimationFrame(() => {
                try { elements.passwordInput.focus(); } catch (e) { /* ignore */ }
            });
        }

        // 隐藏认证模态框
        function hideAuthModal() {
            if (!elements.authModal) return;
            elements.authModal.style.display = 'none';
            // 以兼容不同显示机制，添加 hidden 类
            elements.authModal.classList.add('hidden');
        }

        // 处理身份验证（向后端核验）
        async function handleAuth() {
            const password = elements.passwordInput.value.trim();
            if (!password) {
                elements.authError.textContent = '请输入密码';
                elements.authError.classList.remove('hidden');
                updateAuthStatus(false);
                return;
            }

            try {
                const resp = await fetch('/api/auth/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                const data = await resp.json();
                if (data.success) {
                    // 标记已验证并保存密码用于后续请求
                    authToken = password;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('isAuthenticated', '1');

                    hideAuthModal();
                    updateAuthStatus(true);

                    // 加载系统状态和网盘内容
                    loadSystemStatus();
                    setInterval(loadSystemStatus, 5000);
                    loadCloudFiles();
                } else {
                    elements.authError.textContent = '密码错误，请重试';
                    elements.authError.classList.remove('hidden');
                    localStorage.removeItem('isAuthenticated');
                    updateAuthStatus(false);
                }
            } catch (error) {
                elements.authError.textContent = '验证失败，请重试';
                elements.authError.classList.remove('hidden');
                localStorage.removeItem('isAuthenticated');
                updateAuthStatus(false);
            }
        }

        // 处理登出
        function handleLogout() {
            authToken = null;
            localStorage.removeItem('authToken');
            localStorage.removeItem('isAuthenticated');
            updateAuthStatus(false);
            showAuthModal();
        }

        // 更新认证状态显示
        // authenticated: true=通过, false=失败, undefined=null 表示根据 localStorage 判断或隐藏
        function updateAuthStatus(authenticated) {
            const span = elements.authStatus.querySelector('span');
            if (authenticated === true) {
                elements.authStatus.classList.remove('hidden');
                elements.authStatus.classList.add('flex');
                if (span) { span.textContent = '\u00A0已验证'; span.className = 'text-sm text-green-500'; }
            } else if (authenticated === false) {
                elements.authStatus.classList.remove('hidden');
                elements.authStatus.classList.add('flex');
                if (span) { span.textContent = '\u00A0验证失败'; span.className = 'text-sm text-red-500'; }
            } else {
                // 根据 localStorage.isAuthenticated 决定显示或隐藏
                if (localStorage.getItem('isAuthenticated') === '1' && localStorage.getItem('authToken')) {
                    elements.authStatus.classList.remove('hidden');
                    elements.authStatus.classList.add('flex');
                    if (span) { span.textContent = '\u00A0已验证'; span.className = 'text-sm text-green-500'; }
                } else {
                    elements.authStatus.classList.add('hidden');
                    elements.authStatus.classList.remove('flex');
                }
            }
        }

        // 检查认证状态（尝试使用 localStorage 中的密码自动验证）
        async function checkAuthStatus() {
            updateAuthStatus();
            const stored = localStorage.getItem('authToken');
            if (!stored) {
                showAuthModal();
                return;
            }

            try {
                const resp = await fetch('/api/auth/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: stored })
                });
                const data = await resp.json();
                if (data.success) {
                    authToken = stored;
                    localStorage.setItem('isAuthenticated', '1');
                    updateAuthStatus(true);
                    loadCloudFiles();
                    return;
                } else {
                    // 验证明确失败：清除本地凭据并弹出认证框
                    authToken = null;
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('isAuthenticated');
                    updateAuthStatus(false);
                    showAuthModal();
                    return;
                }
            } catch (err) {
                // 网络或其它错误：记录但不弹出认证框（后台验证失败不可区分网络/服务器问题）
                console.warn('Auth verify error (network?):', err);
                return;
            }
        }

        // 加载系统状态（移除系统信息相关逻辑）
        async function loadSystemStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                // 更新CPU状态
                elements.cpuUsage.textContent = `${data.cpu}%`;
                elements.cpuProgress.style.width = `${data.cpu}%`;
                
                // 更新内存状态
                elements.memUsage.textContent = `${data.memory}%`;
                elements.memProgress.style.width = `${data.memory}%`;
            } catch (error) {
                console.error('加载系统状态失败:', error);
            }
        }

        // 执行系统命令
        async function executeSystemCommand(command) {
            if (!authToken) {
                showAuthModal();
                return;
            }

            try {
                const response = await fetch(`/api/${command}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password: authToken })
                });
                
                const data = await response.json();
                
                // 显示结果
                elements.systemResultText.textContent = data.message;
                elements.systemResult.classList.remove('hidden');
                
                // 如果是成功的关机/重启命令，3秒后提示页面可能无响应
                if (data.success && (command === 'shutdown' || command === 'restart')) {
                    setTimeout(() => {
                        elements.systemResultText.textContent = `${data.message}，页面将可能失去响应`;
                    }, 3000);
                }
                
                // 5秒后隐藏结果提示
                setTimeout(() => {
                    elements.systemResult.classList.add('hidden');
                }, 5000);
            } catch (error) {
                elements.systemResultText.textContent = `执行失败: ${error.message}`;
                elements.systemResult.classList.remove('hidden');
                
                setTimeout(() => {
                    elements.systemResult.classList.add('hidden');
                }, 5000);
            }
        }

        // 切换标签页
        function switchTab(tabId) {
            // 更新标签按钮状态
            elements.tabBtns.forEach(btn => {
                if (btn.dataset.tab === tabId) {
                    btn.classList.add('active', 'border-primary', 'text-primary');
                    btn.classList.remove('border-transparent', 'hover:text-primary', 'dark:hover:text-primary');
                } else {
                    btn.classList.remove('active', 'border-primary', 'text-primary');
                    btn.classList.add('border-transparent', 'hover:text-primary', 'dark:hover:text-primary');
                }
            });
            
            // 更新标签内容状态
            elements.tabContents.forEach(content => {
                if (content.id === tabId) {
                    content.classList.remove('hidden');
                    content.classList.add('block');
                } else {
                    content.classList.add('hidden');
                    content.classList.remove('block');
                }
            });
            
            // 如果切换到网盘标签且已认证，加载文件列表
            if (tabId === 'cloud-storage' && authToken) {
                loadCloudFiles();
            }
        }

        // 加载网盘文件
        async function loadCloudFiles() {
            if (!authToken) return;
            
            // 显示加载状态
            elements.cloudLoading.classList.remove('hidden');
            elements.cloudEmpty.classList.add('hidden');
            elements.fileList.classList.add('hidden');
            
            try {
                const response = await fetch('/api/cloud/list', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        password: authToken,
                        path: currentCloudPath
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // 同步当前路径（以后端返回为准，避免客户端与后端路径不一致）
                    if (data.currentPath !== undefined && data.currentPath !== null) {
                        // 使用 normalizePath 统一规范化（空字符串表示根目录）
                        currentCloudPath = normalizePath(String(data.currentPath));
                    }
                    // 更新路径显示（后端返回的 currentPath 可能是不同分隔符）
                    updatePathDisplay(currentCloudPath);
                    
                    // 清空文件列表
                    elements.fileList.innerHTML = '';
                    
                    if (data.files.length === 0) {
                        // 显示空状态
                        elements.cloudLoading.classList.add('hidden');
                        elements.cloudEmpty.classList.remove('hidden');
                    } else {
                        // 添加文件项
                        data.files.forEach(file => {
                            const fileItem = createFileItemElement(file);
                            // 在列表中统一使用固定图标容器并防止图片拉伸：如果是图片文件，添加缩略图
                            const ext = (file.name || '').split('.').pop().toLowerCase();
                            if (['jpg','jpeg','png','gif','bmp','webp','svg'].includes(ext)) {
                                const icon = fileItem.querySelector('.icon-container');
                                if (icon) {
                                    const img = document.createElement('img');
                                    img.className = 'icon-thumb';
                                    img.src = `/api/cloud/preview?password=${encodeURIComponent(authToken)}&path=${encodeURIComponent(file.path)}`;
                                    img.alt = file.name;
                                    icon.innerHTML = '';
                                    icon.appendChild(img);
                                }
                            }
                            elements.fileList.appendChild(fileItem);
                        });
                        
                        // 显示文件列表
                        elements.cloudLoading.classList.add('hidden');
                        elements.fileList.classList.remove('hidden');
                    }
                } else {
                    showCloudResult(data.message, false);
                    elements.cloudLoading.classList.add('hidden');
                    elements.cloudEmpty.classList.remove('hidden');
                }
            } catch (error) {
                showCloudResult(`加载失败: ${error.message}`, false);
                elements.cloudLoading.classList.add('hidden');
                elements.cloudEmpty.classList.remove('hidden');
            }
        }

        // 创建文件项元素（使用固定尺寸容器修复图标变形）
        function createFileItemElement(file) {
            const div = document.createElement('div');
            div.className = 'file-item';
            div.dataset.path = file.path;
            div.dataset.isDirectory = file.isDirectory;
            
            // 图标（使用固定尺寸容器）
            const icon = document.createElement('div');
            icon.className = 'icon-container mr-3'; // 固定尺寸类
            if (file.isDirectory) {
                icon.innerHTML = '<i class="fa fa-folder text-yellow-500"></i>';
                // 文件夹点击事件（规范化为使用正斜杠）
                const folderPath = normalizePath(String(file.path || ''));
                // 将规范化路径存入 dataset
                div.dataset.path = folderPath;
                div.addEventListener('click', () => navigateToPath(folderPath));
            } else {
                // 根据文件扩展名设置不同图标
                const ext = file.name.split('.').pop().toLowerCase();
                let fileIcon = 'fa-file-o';
                let fileColor = 'text-gray-400';
                
                if (['jpg', 'jpeg', 'png', 'gif', 'bmp'].includes(ext)) {
                    fileIcon = 'fa-file-image-o';
                    fileColor = 'text-pink-500';
                } else if (['mp4', 'avi', 'mov', 'mkv'].includes(ext)) {
                    fileIcon = 'fa-file-video-o';
                    fileColor = 'text-purple-500';
                } else if (['mp3', 'wav', 'flac', 'ogg'].includes(ext)) {
                    fileIcon = 'fa-file-audio-o';
                    fileColor = 'text-green-500';
                } else if (['pdf'].includes(ext)) {
                    fileIcon = 'fa-file-pdf-o';
                    fileColor = 'text-red-500';
                } else if (['doc', 'docx'].includes(ext)) {
                    fileIcon = 'fa-file-word-o';
                    fileColor = 'text-blue-500';
                } else if (['xls', 'xlsx'].includes(ext)) {
                    fileIcon = 'fa-file-excel-o';
                    fileColor = 'text-green-600';
                } else if (['ppt', 'pptx'].includes(ext)) {
                    fileIcon = 'fa-file-powerpoint-o';
                    fileColor = 'text-orange-500';
                } else if (['zip', 'rar', '7z', 'tar'].includes(ext)) {
                    fileIcon = 'fa-file-archive-o';
                    fileColor = 'text-yellow-600';
                } else if (['txt', 'md', 'json', 'xml', 'html', 'css', 'js', 'py', 'java', 'c', 'cpp'].includes(ext)) {
                    fileIcon = 'fa-file-text-o';
                    fileColor = 'text-gray-600 dark:text-gray-300';
                }
                
                icon.innerHTML = `<i class="fa ${fileIcon} ${fileColor}"></i>`;
                
                // 文件点击事件: 不再通过轻触直接下载，避免误触。下载仅通过下载按钮触发。
                // （文件项点击事件已从下载移除；若希望打开预览，可在此添加预览逻辑）
            }

            // 在图标之前插入自定义复选框（始终可见）
            const checkboxWrapper = document.createElement('label');
            checkboxWrapper.className = 'custom-checkbox select-checkbox';
            checkboxWrapper.innerHTML = `\n                <input type="checkbox" class="custom-checkbox-input" aria-label="选择文件项"/>\n                <span class="custom-checkbox-box"><i class="fa fa-check text-white"></i></span>`;
            const cbInput = checkboxWrapper.querySelector('.custom-checkbox-input');
            // 点击复选框只切换选择，不触发文件项的其它点击（如导航）
            cbInput.addEventListener('click', (e) => {
                e.stopPropagation();
                // 首次通过复选框进入选择模式
                if (!selectionMode) enterSelectionMode();
                // 确保 dataset.path 已被规范化
                const p = normalizePath(div.dataset.path || '');
                toggleSelect(p, div, cbInput.checked);
            });

            // 文件信息
            const info = document.createElement('div');
            info.className = 'flex-1 min-w-0';
            
            const name = document.createElement('p');
            name.className = 'font-medium truncate';
            name.textContent = file.name;
            
            const details = document.createElement('p');
            details.className = 'text-xs text-gray-500 dark:text-gray-400';
            if (file.isDirectory) {
                details.textContent = '文件夹';
            } else {
                // 格式化文件大小
                const size = formatFileSize(file.size);
                // 格式化修改时间
                const modified = new Date(file.modified).toLocaleString();
                details.textContent = `${size} · ${modified}`;
            }
            
            info.appendChild(name);
            info.appendChild(details);
            
            // 操作按钮
            const actions = document.createElement('div');
            actions.className = 'opacity-0 hover:opacity-100 transition-all-300 flex items-center gap-2';

            // 下载按钮（仅对文件显示）
            // 预览按钮（仅对支持的类型显示）
            const previewBtn = document.createElement('button');
            previewBtn.className = 'icon-btn-sm text-gray-400 hover:text-primary transition-all-300';
            previewBtn.innerHTML = '<i class="fa fa-eye"></i>';
            previewBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (!authToken) { showAuthModal(); return; }
                const ext = (file.name || '').split('.').pop().toLowerCase();
                if (['jpg','jpeg','png','gif','bmp','webp','svg'].includes(ext)) {
                    showPreviewModal('image', file);
                } else if (['mp4','avi','mov','mkv','webm'].includes(ext)) {
                    showPreviewModal('video', file);
                } else if (['mp3','wav','flac','ogg'].includes(ext)) {
                    showPreviewModal('audio', file);
                } else if (['txt','md','json','xml','html','css','js','py','java','c','cpp','log','csv'].includes(ext)) {
                    showPreviewModal('text', file);
                } else if (ext === 'epub') {
                    // 使用 epub.js 前端渲染
                    showPreviewModal('epub', file);
                } else if (['pdf','doc','docx'].includes(ext)) {
                    // 使用后端 preview (docx -> html) 或 浏览器内嵌 pdf
                    showPreviewModal('document', file);
                } else {
                    showCloudResult('此文件类型不支持预览，建议下载后查看', false);
                }
            });

            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'icon-btn-sm text-gray-400 hover:text-primary transition-all-300';
            downloadBtn.innerHTML = '<i class="fa fa-download"></i>';
            downloadBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                // 使用文件的原始路径与名称进行下载
                downloadFile(file.path, file.name);
            });

            // 删除按钮
            const deleteBtn = document.createElement('button');
            // 使用统一的小图标按钮类，保证尺寸和对齐一致
            deleteBtn.className = 'icon-btn-sm text-gray-400 hover:text-red-500 transition-all-300';
            deleteBtn.innerHTML = '<i class="fa fa-trash-o"></i>';
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                showDeleteModal(file.name, normalizePath(file.path));
            });

            // 先添加预览、下载，再添加删除（视觉顺序）
            actions.appendChild(previewBtn);
            actions.appendChild(downloadBtn);
            actions.appendChild(deleteBtn);
            // 重命名按钮
            const renameBtn = document.createElement('button');
            renameBtn.className = 'icon-btn-sm text-gray-400 hover:text-primary transition-all-300';
            renameBtn.innerHTML = '<i class="fa fa-edit"></i>';
            renameBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                showRenameModal(normalizePath(file.path), file.name);
            });
            actions.appendChild(renameBtn);
            
            // 组装
            // 如果目录项的 dataset.path 尚未设置（文件情况），也写入规范化路径
            if (!div.dataset.path) div.dataset.path = normalizePath(String(file.path || ''));

            // 先插入复选框，再插入图标和信息
            div.appendChild(checkboxWrapper);
            div.appendChild(icon);
            div.appendChild(info);
            div.appendChild(actions);
            
            // 鼠标悬停显示操作按钮
            div.addEventListener('mouseenter', () => {
                actions.classList.remove('opacity-0');
                actions.classList.add('opacity-100');
            });
            
            div.addEventListener('mouseleave', () => {
                actions.classList.add('opacity-0');
                actions.classList.remove('opacity-100');
            });
            
            return div;
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 更新路径显示（修复分隔符重复问题）
        function updatePathDisplay(path) {
            // 规范化路径
            const norm = normalizePath(path);
            // 清空动态路径容器（避免重复添加）
            elements.dynamicPathContainer.innerHTML = '';

            if (!norm) {
                // 根目录：不显示面包屑项
                // 隐藏返回上级按钮
                const goUpBtn = document.getElementById('go-up-btn');
                if (goUpBtn) goUpBtn.style.display = 'none';
                return;
            }

            // 隐藏/显示返回上级按钮
            const goUpBtn = document.getElementById('go-up-btn');
            if (goUpBtn) {
                goUpBtn.style.display = norm ? 'inline-flex' : 'none';
            }

            // 分割路径（统一处理斜杠）
            const parts = norm.split('/').filter(Boolean);
            if (parts.length === 0) return;

            // 构建动态路径（按顺序添加：项 + 分隔符）
            let currentPath = '';
            parts.forEach((part, index) => {
                currentPath += (currentPath ? '/' : '') + part;

                // 添加路径项（一个可点击的片段）
                const pathItem = document.createElement('a');
                pathItem.className = 'path-item cursor-pointer';
                pathItem.dataset.path = currentPath;
                pathItem.textContent = part;
                pathItem.addEventListener('click', (e) => {
                    e.preventDefault();
                    navigateToPath(currentPath);
                });
                elements.dynamicPathContainer.appendChild(pathItem);

                // 如果不是最后一个，添加分隔符
                if (index < parts.length - 1) {
                    const separator = document.createElement('i');
                    separator.className = 'fa fa-angle-right text-gray-400 mx-2';
                    elements.dynamicPathContainer.appendChild(separator);
                }
            });
        }

        function updateMoveButtonState() {
            const btn = document.getElementById('select-move');
            if (!btn) return;
            // 当处于选择模式并且选择来源和当前路径不同时，允许移动
            if (selectionMode && normalizePath(selectionOrigin) !== normalizePath(currentCloudPath)) {
                btn.disabled = false;
                btn.classList.remove('opacity-50');
            } else {
                btn.disabled = true;
                btn.classList.add('opacity-50');
            }
        }

        // 导航到指定路径
        function navigateToPath(path) {
            const norm = normalizePath(path);
            currentCloudPath = norm;
            // 先更新面包屑，这样用户会看到立即变化，再加载内容
            updatePathDisplay(currentCloudPath);
            // 确保切换到网盘 tab
            switchTab('cloud-storage');
            loadCloudFiles();
            // 更新移动按钮状态（导航后可能已处于目标文件夹）
            updateMoveButtonState();
        }

        // 显示创建文件夹模态框
        function showCreateFolderModal() {
            if (!authToken) {
                showAuthModal();
                return;
            }
            
            elements.createFolderModal.style.display = 'flex';
            elements.folderNameInput.value = '';
            elements.folderError.classList.add('hidden');
            elements.folderNameInput.focus();
        }

        // 隐藏创建文件夹模态框
        function hideCreateFolderModal() {
            elements.createFolderModal.style.display = 'none';
        }

        // 创建文件夹
        async function createFolder() {
            const folderName = elements.folderNameInput.value.trim();
            if (!folderName) {
                elements.folderError.textContent = '请输入文件夹名称';
                elements.folderError.classList.remove('hidden');
                return;
            }
            
            try {
                const response = await fetch('/api/cloud/mkdir', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        password: authToken,
                        path: currentCloudPath,
                        name: folderName
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    hideCreateFolderModal();
                    showCloudResult('文件夹创建成功', true);
                    loadCloudFiles();
                } else {
                    elements.folderError.textContent = data.message;
                    elements.folderError.classList.remove('hidden');
                }
            } catch (error) {
                elements.folderError.textContent = `创建失败: ${error.message}`;
                elements.folderError.classList.remove('hidden');
            }
        }

        // 显示删除模态框
        function showDeleteModal(itemName, itemPath) {
            elements.deleteItemName.textContent = itemName;
            elements.deleteItemPath.value = itemPath;
            elements.deleteModal.style.display = 'flex';
        }

        // 隐藏删除模态框
        function hideDeleteModal() {
            elements.deleteModal.style.display = 'none';
        }

        // 删除文件/文件夹
        async function deleteItem() {
            const itemPathRaw = elements.deleteItemPath.value;
            const itemPath = normalizePath(itemPathRaw);
            if (!itemPath) return;

            try {
                const response = await fetch('/api/cloud/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        password: authToken,
                        path: itemPath
                    })
                });

                const data = await response.json();

                if (data.success) {
                    hideDeleteModal();
                    showCloudResult('删除成功', true);

                    // 如果删除的是当前目录本身，导航到它的父目录
                    const normCurrent = normalizePath(currentCloudPath);
                    if (normCurrent === itemPath) {
                        const idx = normCurrent.lastIndexOf('/');
                        const parentPath = idx > 0 ? normCurrent.substring(0, idx) : '';
                        navigateToPath(parentPath);
                        return;
                    }

                    // 如果被删除路径是当前路径的祖先（例如删除了上层文件夹），则导航到根或最近存在的父
                    if (normCurrent && normCurrent.startsWith(itemPath + '/')) {
                        // 计算新的父目录
                        const idx = itemPath.lastIndexOf('/');
                        const parentPath = idx > 0 ? itemPath.substring(0, idx) : '';
                        navigateToPath(parentPath);
                        return;
                    }

                    // 其它情况刷新当前目录
                    loadCloudFiles();
                } else {
                    showCloudResult(data.message, false);
                    hideDeleteModal();
                }
            } catch (error) {
                showCloudResult(`删除失败: ${error.message}`, false);
                hideDeleteModal();
            }
        }

        // 处理文件上传
        function handleFileUpload(e) {
            if (!authToken) {
                showAuthModal();
                return;
            }
            
            const files = e.target.files;
            if (!files || files.length === 0) return;
            // 逐个上传文件（不要立即清空 input，等上传完成再清空）
            uploadFiles(files, 0);
        }

        // 上传文件
        function uploadFiles(files, index, successCount = 0) {
            if (index >= files.length) {
                // 所有文件上传完成
                hideUploadModal();
                // 清空文件输入以便下次上传可以触发 change
                elements.fileUpload.value = '';
                showCloudResult(`成功上传 ${successCount} 个文件`, true);
                loadCloudFiles();
                return;
            }

            const file = files[index];
            const formData = new FormData();
            
            formData.append('file', file);
            formData.append('password', authToken);
            formData.append('path', currentCloudPath);

            // 显示上传模态框
            showUploadModal(file.name);

            // 创建XHR对象
            uploadXHR = new XMLHttpRequest();
            // 将当前路径通过 query 参数传给后端，multer 的 destination 会使用 req.query.path
            const uploadUrl = `/api/cloud/upload?path=${encodeURIComponent(normalizePath(currentCloudPath) || '')}`;
            uploadXHR.open('POST', uploadUrl, true);

            // 上传进度
            uploadXHR.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percent = Math.round((e.loaded / e.total) * 100);
                    elements.uploadProgress.style.width = `${percent}%`;
                    elements.uploadPercentage.textContent = `${percent}%`;

                    // 计算上传速率
                    try {
                        const now = Date.now();
                        if (!uploadState) {
                            uploadState = { startTime: now, lastLoaded: e.loaded, lastTime: now };
                        } else {
                            const deltaBytes = e.loaded - (uploadState.lastLoaded || 0);
                            const deltaTime = (now - (uploadState.lastTime || now)) / 1000; // s
                            if (deltaTime > 0 && deltaBytes >= 0) {
                                const bps = deltaBytes / deltaTime;
                                if (elements.uploadSpeed) elements.uploadSpeed.textContent = `速率: ${formatBytesPerSecond(bps)}`;
                            }
                            uploadState.lastLoaded = e.loaded;
                            uploadState.lastTime = now;
                        }
                    } catch (err) {
                        // ignore
                    }
                }
            });

            // 上传完成
            uploadXHR.addEventListener('load', () => {
                try {
                    const data = JSON.parse(uploadXHR.responseText);
                    if (data && data.success) {
                        // 计数成功的上传
                        successCount = successCount + 1;
                        // 上传下一个文件
                        uploadFiles(files, index + 1, successCount);
                    } else {
                        hideUploadModal();
                        // 清空输入以避免残留状态
                        elements.fileUpload.value = '';
                        const msg = data && data.message ? data.message : '未知错误';
                        showCloudResult(`上传失败: ${msg}`, false);
                    }
                } catch (err) {
                    hideUploadModal();
                    elements.fileUpload.value = '';
                    showCloudResult(`上传失败: ${err.message}`, false);
                }
            });

            // 上传错误
            uploadXHR.addEventListener('error', () => {
                hideUploadModal();
                showCloudResult('上传失败: 网络错误', false);
            });

            // 发送请求
            uploadXHR.send(formData);
        }

        // 显示上传模态框
        function showUploadModal(filename) {
            elements.uploadFilename.textContent = `正在上传: ${filename}`;
            elements.uploadProgress.style.width = '0%';
            elements.uploadPercentage.textContent = '0%';
            // 初始化上传速率计算
            uploadState = { startTime: Date.now(), lastLoaded: 0, lastTime: Date.now() };
            if (elements.uploadSpeed) elements.uploadSpeed.textContent = '速率: 0 KB/s';
            elements.uploadModal.style.display = 'flex';
        }

        // 隐藏上传模态框
        function hideUploadModal() {
            elements.uploadModal.style.display = 'none';
            uploadXHR = null;
            uploadState = null;
            if (elements.uploadSpeed) elements.uploadSpeed.textContent = '速率: 0 KB/s';
        }

        // 取消上传
        function cancelUpload() {
            if (uploadXHR) {
                uploadXHR.abort();
                uploadXHR = null;
            }
            hideUploadModal();
            showCloudResult('上传已取消', false);
        }

        // 格式化速度（bytes/s -> 可读字符串）
        function formatBytesPerSecond(bps) {
            if (!bps || bps <= 0) return '0 KB/s';
            const units = ['B/s', 'KB/s', 'MB/s', 'GB/s'];
            let i = 0;
            let val = bps;
            while (val >= 1024 && i < units.length - 1) {
                val /= 1024;
                i++;
            }
            return `${val.toFixed(2)} ${units[i]}`;
        }

        // 下载文件（使用直接链接方式，避免 fetch 在局域网/域名下下载大文件失败）
        async function downloadFile(filePath, fileName) {
            if (!authToken) {
                showAuthModal();
                return;
            }

            try {
                // 构造 GET 下载链接（后端已提供 GET /api/cloud/download）
                const url = `/api/cloud/download?password=${encodeURIComponent(authToken)}&path=${encodeURIComponent(filePath)}`;

                // 使用临时 a 标签并触发点击，以便浏览器处理为直接下载（支持大文件）
                const a = document.createElement('a');
                a.href = url;
                // 新窗口下载不会影响当前页面状态
                a.target = '_blank';
                a.rel = 'noopener noreferrer';
                // 可选：设置 download 属性以建议文件名，但当跨域或 Content-Disposition 存在时浏览器可能忽略
                if (fileName) a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                showCloudResult(`开始下载: ${fileName || '文件'}`, true);
            } catch (error) {
                showCloudResult(`下载失败: ${error.message}`, false);
            }
        }

        // 执行搜索并渲染结果（调用后端 /api/cloud/search）
        async function performSearch(query) {
            if (!authToken) { showAuthModal(); return; }
            const trimmed = String(query || '').trim();
            // 收集选中的 filter types
            const types = [];
            document.querySelectorAll('.filter-btn').forEach(b => {
                if (b.classList.contains('bg-primary')) types.push(b.dataset.type);
            });

            // 如果没有 query 且没有类型过滤，则加载常规目录
            if (!trimmed && types.length === 0) {
                elements.clearSearchBtn.classList.add('hidden');
                loadCloudFiles();
                return;
            }

            // 显示清除按钮
            if (elements.clearSearchBtn) elements.clearSearchBtn.classList.remove('hidden');

            elements.cloudLoading.classList.remove('hidden');
            elements.cloudEmpty.classList.add('hidden');
            elements.fileList.classList.add('hidden');

            try {
                const resp = await fetch('/api/cloud/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: authToken, path: currentCloudPath, query: trimmed, types })
                });
                const data = await resp.json();
                if (data.success) {
                    elements.fileList.innerHTML = '';
                    if (!data.files || data.files.length === 0) {
                        elements.cloudLoading.classList.add('hidden');
                        elements.cloudEmpty.classList.remove('hidden');
                        return;
                    }

                    data.files.forEach(f => {
                        // make file object compatible with createFileItemElement
                        const file = { name: f.name, path: f.path, size: f.size, modified: f.modified, isDirectory: f.isDirectory };
                        const item = createFileItemElement(file);
                        // 如果是图片，加载缩略图
                        const ext = (file.name || '').split('.').pop().toLowerCase();
                        if (['jpg','jpeg','png','gif','bmp','webp','svg'].includes(ext)) {
                            const icon = item.querySelector('.icon-container');
                            if (icon) {
                                const img = document.createElement('img');
                                img.className = 'icon-thumb';
                                img.src = `/api/cloud/preview?password=${encodeURIComponent(authToken)}&path=${encodeURIComponent(file.path)}`;
                                img.alt = file.name;
                                icon.innerHTML = '';
                                icon.appendChild(img);
                            }
                        }
                        elements.fileList.appendChild(item);
                    });

                    elements.cloudLoading.classList.add('hidden');
                    elements.fileList.classList.remove('hidden');
                } else {
                    showCloudResult(data.message || '搜索失败', false);
                    elements.cloudLoading.classList.add('hidden');
                    elements.cloudEmpty.classList.remove('hidden');
                }
            } catch (err) {
                showCloudResult(`搜索失败: ${err.message}`, false);
                elements.cloudLoading.classList.add('hidden');
                elements.cloudEmpty.classList.remove('hidden');
            }
        }

        // 显示网盘操作结果
        function showCloudResult(message, isSuccess) {
            elements.cloudResultText.textContent = message;
            
            if (isSuccess) {
                elements.cloudResult.className = 'mt-4 p-4 rounded-lg bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 text-green-700 dark:text-green-300';
            } else {
                elements.cloudResult.className = 'mt-4 p-4 rounded-lg bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-300';
            }
            
            elements.cloudResult.classList.remove('hidden');
            
            // 5秒后隐藏
            setTimeout(() => {
                elements.cloudResult.classList.add('hidden');
            }, 5000);
        }

        // 预览模态框控制：显示/隐藏（支持 image/video/audio/text）
        // 预览模态框控制：显示/隐藏（支持 image/video/audio/text，并为视频提供大播放器 / 键盘快捷键）
        (function() {
            let _keyHandler = null;
            let _currentMediaEl = null;

            function bindKeyHandlers() {
                if (_keyHandler) return;
                _keyHandler = function(e) {
                    if (!document.getElementById('preview-modal') || document.getElementById('preview-modal').classList.contains('hidden')) return;
                    // Space: 播放/暂停（默认阻止页面滚动）
                    if (e.code === 'Space') {
                        if (_currentMediaEl && typeof _currentMediaEl.paused !== 'undefined') {
                            e.preventDefault();
                            if (_currentMediaEl.paused) _currentMediaEl.play(); else _currentMediaEl.pause();
                        }
                    }
                    // KeyF: 切换全屏
                    if (e.key === 'f' || e.key === 'F') {
                        const container = document.getElementById('preview-container');
                        if (container) {
                            if (document.fullscreenElement) {
                                document.exitFullscreen().catch(()=>{});
                            } else {
                                container.requestFullscreen().catch(()=>{});
                            }
                        }
                    }
                    // Esc: 关闭模态
                    if (e.key === 'Escape') hidePreviewModal();
                };
                document.addEventListener('keydown', _keyHandler);
            }

            function unbindKeyHandlers() {
                if (_keyHandler) {
                    document.removeEventListener('keydown', _keyHandler);
                    _keyHandler = null;
                }
            }

            function showPreviewModal(type, file) {
                const modal = document.getElementById('preview-modal');
                const content = document.getElementById('preview-content');
                const title = document.getElementById('preview-title');
                const toolbar = document.getElementById('preview-toolbar');
                const spinner = document.getElementById('preview-spinner');
                const largeBtn = document.getElementById('preview-large');
                if (!modal || !content) return;
                title.textContent = file && file.name ? file.name : '预览';
                // 每次打开预览清空内容与工具栏，防止上次遗留控件
                content.innerHTML = '';
                if (toolbar) {
                    toolbar.innerHTML = '';
                    // 默认隐藏工具栏，只有特定类型（如 epub）会显示自定义工具栏
                    toolbar.classList.add('hidden');
                }
                if (spinner) spinner.classList.remove('hidden');
                // 默认隐藏全屏控件，只有视频会显示
                if (largeBtn) {
                    largeBtn.style.display = 'none';
                    largeBtn.onclick = null;
                }

                // 将文件路径放入 URL 路径段，使 epub.js 的相对请求变为 /api/cloud/download/<file>/...，便于后端按需处理
                const downloadUrl = `/api/cloud/download/${encodeURIComponent(file.path)}?password=${encodeURIComponent(authToken)}&inline=1`;
                const previewUrl = `/api/cloud/preview?password=${encodeURIComponent(authToken)}&path=${encodeURIComponent(file.path)}`;

                // 清理上次的 media 引用或 epub 实例
                _currentMediaEl = null;
                if (window._epubRendition) {
                    try { window._epubRendition.destroy(); } catch (e) {}
                    window._epubRendition = null;
                    window._epubBook = null;
                }

                const hideSpinner = () => { if (spinner) spinner.classList.add('hidden'); };

                if (type === 'image') {
                    const img = document.createElement('img');
                    img.src = downloadUrl;
                    img.className = 'max-w-full max-h-[80vh] object-contain';
                    img.alt = file.name || 'image';
                    img.onload = () => { hideSpinner(); };
                    img.onerror = () => { hideSpinner(); content.innerHTML = '<p class="text-sm text-red-500">图片加载失败</p>'; };
                    content.appendChild(img);
                } else if (type === 'video') {
                    const wrap = document.createElement('div');
                    wrap.className = 'w-full flex items-center justify-center';
                    const v = document.createElement('video');
                    v.src = downloadUrl;
                    v.controls = true;
                    v.autoplay = true;
                    v.preload = 'metadata';
                    v.className = 'w-full max-h-[80vh] bg-black';
                    v.addEventListener('loadeddata', () => { hideSpinner(); });
                    v.addEventListener('error', () => { hideSpinner(); content.innerHTML = '<p class="text-sm text-red-500">视频无法播放</p>'; });
                    wrap.appendChild(v);
                    content.appendChild(wrap);
                    _currentMediaEl = v;

                    if (largeBtn) {
                        largeBtn.onclick = () => {
                            const target = v || document.getElementById('preview-container');
                            if (target.requestFullscreen) target.requestFullscreen().catch(()=>{});
                        };
                    }
                } else if (type === 'audio') {
                    const a = document.createElement('audio');
                    a.src = downloadUrl;
                    a.controls = true;
                    a.className = 'w-full';
                    a.addEventListener('canplay', () => { hideSpinner(); });
                    a.addEventListener('error', () => { hideSpinner(); content.innerHTML = '<p class="text-sm text-red-500">音频无法播放</p>'; });
                    content.appendChild(a);
                    _currentMediaEl = a;
                    if (largeBtn) largeBtn.onclick = () => { const target = a || document.getElementById('preview-container'); if (target.requestFullscreen) target.requestFullscreen().catch(()=>{}); };
                } else if (type === 'text') {
                    fetch(downloadUrl).then(r => {
                        if (!r.ok) throw new Error('无法获取文件');
                        return r.text();
                    }).then(txt => {
                        hideSpinner();
                        const pre = document.createElement('pre');
                        pre.className = 'whitespace-pre-wrap text-sm font-mono text-gray-800 dark:text-gray-200 p-2';
                        pre.textContent = txt;
                        content.appendChild(pre);
                    }).catch(err => {
                        hideSpinner();
                        content.innerHTML = `<p class="text-sm text-red-500">预览失败: ${err.message}</p>`;
                    });
                    if (largeBtn) largeBtn.onclick = null;
                } else if (type === 'epub') {
                    const readerWrap = document.createElement('div');
                    readerWrap.id = 'epub-reader';
                    readerWrap.style.width = '100%';
                    readerWrap.style.height = '80vh';
                    readerWrap.style.overflow = 'hidden';
                    content.appendChild(readerWrap);

                    // 获取 epub 并以 Blob 形式传入 epub.js，避免 epub.js 发起错误的相对请求
                    fetch(downloadUrl).then(resp => {
                        if (!resp.ok) throw new Error(`无法获取 EPUB: ${resp.status}`);
                        return resp.arrayBuffer();
                    }).then(ab => {
                        // 直接把 ArrayBuffer 传给 epub.js，避免任何后续网络请求
                        const book = ePub(ab);
                        const rendition = book.renderTo(readerWrap, { width: '100%', height: '80vh' });
                        window._epubBook = book;
                        window._epubRendition = rendition;
                        rendition.display().then(() => hideSpinner()).catch(()=>hideSpinner());

                        if (toolbar) {
                            // 替换原来的“位置”显示，改为跳转到页面的控件（页码输入 + 跳转按钮）
                            toolbar.innerHTML = '<div class="flex items-center gap-2"><button id="epub-prev" class="btn btn-sm">上页</button><button id="epub-next" class="btn btn-sm">下页</button><div class="ml-4 flex items-center gap-2"><input id="epub-page-input" type="number" min="1" placeholder="页码" class="input" style="width:80px;height:32px;padding:4px" /><button id="epub-goto" class="btn btn-sm">跳转</button></div></div>';
                            // 确保工具栏可见
                            toolbar.classList.remove('hidden');

                            const prev = document.getElementById('epub-prev');
                            const next = document.getElementById('epub-next');
                            const pageInput = document.getElementById('epub-page-input');
                            const gotoBtn = document.getElementById('epub-goto');

                            // 基本翻页操作直接委托给 rendition，保证按钮在 preview 打开时可用
                            prev.onclick = () => { try { rendition.prev(); } catch (e) {} };
                            next.onclick = () => { try { rendition.next(); } catch (e) {} };

                            // 在 locations 准备好之前禁用跳转，避免误点
                            gotoBtn.disabled = true;

                            // 在 book 准备好后生成 locations，用于页码到 CFI 的映射
                            try {
                                if (window._epubBook) {
                                    window._epubBook.ready.then(() => {
                                        try {
                                            return window._epubBook.locations.generate();
                                        } catch (e) { return null; }
                                    }).then(() => {
                                        try {
                                            const total = (window._epubBook.locations && typeof window._epubBook.locations.length === 'function') ? window._epubBook.locations.length() : null;
                                            window._epubTotalLocations = total;
                                            // 如果 total 很大（例如 > 10000），在控制台记录以便调试
                                            if (typeof total === 'number') console.debug('[EPUB] total locations =', total);
                                            // 启用跳转按钮
                                            gotoBtn.disabled = false;
                                            // 当用户输入页码并点击跳转时，按位置索引转换为百分比再转为 CFI
                                            gotoBtn.onclick = () => {
                                                const v = parseInt(pageInput.value, 10);
                                                if (!v || !total) { alert('无法跳转：页码或位置索引不可用'); return; }
                                                // 限制页码范围
                                                const idx = Math.max(1, Math.min(v, total));
                                                // 使用 (idx-1)/(total-1) 映射到 0..100%，避免总是落在前几页的问题
                                                const pct = total > 1 ? ((idx - 1) / (total - 1)) * 100 : 0;
                                                try {
                                                    // 调试信息：打印到控制台以便排查大文件问题
                                                    console.debug('[EPUB JUMP] idx=', idx, 'total=', total, 'pct=', pct);
                                                    const cfi = window._epubBook.locations.cfiFromPercentage(pct);
                                                    rendition.display(cfi);
                                                } catch (e) {
                                                    console.error('EPUB 跳转失败', e);
                                                    alert('跳转失败: ' + e.message);
                                                }
                                            };
                                        } catch (e) {}
                                    }).catch(()=>{});
                                }
                            } catch (e) {}

                            // 更新输入框为当前位置（如果可用）
                            rendition.on('relocated', (locData) => {
                                try {
                                    if (pageInput && locData && locData.start) {
                                        // locData.start.location 在某些版本中存在，表示位置索引
                                        if (typeof locData.start.location !== 'undefined' && window._epubTotalLocations) {
                                            pageInput.value = (locData.start.location + 1);
                                        } else if (typeof locData.start.cfi === 'string' && window._epubBook && window._epubBook.locations && typeof window._epubBook.locations.percentageFromCfi === 'function') {
                                            const pct = window._epubBook.locations.percentageFromCfi(locData.start.cfi) || 0;
                                            if (window._epubTotalLocations) pageInput.value = Math.round((pct / 100) * window._epubTotalLocations);
                                        }
                                    }
                                } catch (e) {}
                            });
                        }
                    }).catch(err => {
                        hideSpinner();
                        content.innerHTML = `<p class="text-sm text-red-500">EPUB 渲染失败: ${err.message}</p>`;
                    });
                } else if (type === 'document') {
                    const ext = (file.name || '').split('.').pop().toLowerCase();
                    if (ext === 'docx') {
                        fetch(previewUrl).then(r => {
                            if (!r.ok) throw new Error('无法获取文档预览');
                            return r.text();
                        }).then(html => {
                            hideSpinner();
                            const wrap = document.createElement('div');
                            wrap.className = 'w-full max-h-[80vh] overflow-auto';
                            wrap.innerHTML = html;
                            content.appendChild(wrap);
                        }).catch(err => {
                            hideSpinner();
                            content.innerHTML = `<p class="text-sm text-red-500">文档预览失败: ${err.message}</p>`;
                        });
                    } else if (ext === 'pdf') {
                        const iframe = document.createElement('iframe');
                        iframe.src = downloadUrl;
                        iframe.style.width = '100%';
                        iframe.style.height = '80vh';
                        iframe.frameBorder = '0';
                        iframe.onload = () => hideSpinner();
                        iframe.onerror = () => { hideSpinner(); content.innerHTML = '<p class="text-sm text-red-500">PDF 加载失败</p>'; };
                        content.appendChild(iframe);
                    } else {
                        hideSpinner();
                        content.innerHTML = '<p class="text-sm">此文档类型暂不支持在线预览</p>';
                    }
                } else {
                    hideSpinner();
                    content.innerHTML = '<p class="text-sm">不支持的预览类型</p>';
                    if (largeBtn) largeBtn.onclick = null;
                }

                modal.style.display = 'flex';
                modal.classList.remove('hidden');

                const closeBtn = document.getElementById('preview-close');
                if (closeBtn && !closeBtn._previewBound) {
                    closeBtn.addEventListener('click', hidePreviewModal);
                    closeBtn._previewBound = true;
                }

                if (!modal._overlayBound) {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) hidePreviewModal();
                    });
                    modal._overlayBound = true;
                }

                bindKeyHandlers();
            }

            function hidePreviewModal() {
                const modal = document.getElementById('preview-modal');
                const content = document.getElementById('preview-content');
                const spinner = document.getElementById('preview-spinner');
                const toolbar = document.getElementById('preview-toolbar');
                const largeBtn = document.getElementById('preview-large');
                if (!modal) return;
                // try exit fullscreen if open
                if (document.fullscreenElement) {
                    document.exitFullscreen().catch(()=>{});
                }
                modal.style.display = 'none';
                modal.classList.add('hidden');
                if (content) {
                    // pause media if exists
                    try {
                        if (_currentMediaEl && typeof _currentMediaEl.pause === 'function') _currentMediaEl.pause();
                    } catch (e) {}
                    content.innerHTML = '';
                }
                if (spinner) spinner.classList.add('hidden');
                if (toolbar) toolbar.classList.add('hidden');
                if (largeBtn) largeBtn.onclick = null;
                _currentMediaEl = null;
                // 销毁 epub 实例（无需撤销 Blob URL，因为我们传入的是 ArrayBuffer）
                try { if (window._epubRendition) { window._epubRendition.destroy(); } } catch (e) {}
                window._epubRendition = null;
                window._epubBook = null;
                unbindKeyHandlers();
            }

            // 导出到全局作用域
            window.showPreviewModal = showPreviewModal;
            window.hidePreviewModal = hidePreviewModal;
        })();

        // 初始化应用
        document.addEventListener('DOMContentLoaded', init);
    // 批量选择相关状态
        let selectionMode = false;
        const selectedSet = new Set();
    let selectionOrigin = '';

        function enterSelectionMode() {
            selectionMode = true;
            document.getElementById('selection-toolbar').style.display = 'flex';
            selectionOrigin = normalizePath(currentCloudPath);
            // 在文件项上显示复选框
            document.querySelectorAll('#file-list .file-item').forEach(item => {
                let cb = item.querySelector('.select-checkbox');
                if (!cb) {
                    cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.className = 'select-checkbox';
                    cb.addEventListener('click', (e) => {
                        e.stopPropagation();
                        toggleSelect(item.dataset.path, item, cb.checked);
                    });
                    item.appendChild(cb);
                }
                // 始终保持可见，使用 inline-flex 以与新样式一致
                cb.style.display = 'inline-flex';
            });
            // 更新移动按钮状态
            updateMoveButtonState();
        }

        function exitSelectionMode() {
            selectionMode = false;
            selectedSet.clear();
            document.getElementById('selection-toolbar').style.display = 'none';
            document.querySelectorAll('#file-list .file-item').forEach(item => {
                const cb = item.querySelector('.select-checkbox');
                // 不再隐藏复选框，始终显示
                if (cb) cb.style.display = 'inline-flex';
                item.classList.remove('selected');
            });
            // 更新移动按钮状态
            updateMoveButtonState();
        }

        function toggleSelect(path, itemEl, select) {
            const p = normalizePath(path || '');
            const cbInput = itemEl.querySelector('.custom-checkbox-input') || itemEl.querySelector('input.select-checkbox');
            if (select) {
                selectedSet.add(p);
                itemEl.classList.add('selected');
                if (cbInput) cbInput.checked = true;
            } else {
                selectedSet.delete(p);
                itemEl.classList.remove('selected');
                if (cbInput) cbInput.checked = false;
            }
            // 更新移动按钮状态
            updateMoveButtonState();
        }

        // 长按识别（移动/删除常见模式）
        let pressTimer = null;
        function attachLongPressHandlers() {
            document.querySelectorAll('#file-list .file-item').forEach(item => {
                item.addEventListener('mousedown', (e) => {
                    if (pressTimer) clearTimeout(pressTimer);
                    pressTimer = setTimeout(() => {
                        // 进入选择模式并选择当前项
                        if (!selectionMode) enterSelectionMode();
                        const cbInput = item.querySelector('.custom-checkbox-input') || item.querySelector('input.select-checkbox');
                        if (cbInput) { cbInput.checked = true; toggleSelect(item.dataset.path, item, true); }
                    }, 500);
                });
                item.addEventListener('mouseup', (e) => { if (pressTimer) { clearTimeout(pressTimer); pressTimer = null; } });
                item.addEventListener('mouseleave', (e) => { if (pressTimer) { clearTimeout(pressTimer); pressTimer = null; } });
                // 点击选择/打开
                item.addEventListener('click', (e) => {
                    // 如果在选择模式，点击切换选择
                    if (selectionMode) {
                        e.stopPropagation();
                        const cbInput = item.querySelector('.custom-checkbox-input') || item.querySelector('input.select-checkbox');
                        if (cbInput) { cbInput.checked = !cbInput.checked; toggleSelect(item.dataset.path, item, cbInput.checked); }
                        return;
                    }
                    // 否则保持原有行为（已绑定在创建项时）
                });
            });
        }

        // 在每次加载 cloud 文件后必须重新调用以绑定长按事件
        const original_loadCloudFiles = loadCloudFiles;
        loadCloudFiles = async function() {
            await original_loadCloudFiles();
            // 绑定长按
            attachLongPressHandlers();

            // 如果当前处于选择模式，保留选择状态：
            // - 显示工具栏
            // - 在新加载的文件项上显示复选框并恢复已选状态
            const toolbar = document.getElementById('selection-toolbar');
            if (selectionMode) {
                if (toolbar) toolbar.style.display = 'flex';
                document.querySelectorAll('#file-list .file-item').forEach(item => {
                    // 寻找自定义复选框输入
                    let cbInput = item.querySelector('.custom-checkbox-input') || item.querySelector('input.select-checkbox');
                    // 如果没有现成的 input（极少情况），创建一个与旧逻辑兼容的 input
                    if (!cbInput) {
                        const tmp = document.createElement('input');
                        tmp.type = 'checkbox';
                        tmp.className = 'select-checkbox';
                        tmp.addEventListener('click', (e) => { e.stopPropagation(); toggleSelect(item.dataset.path, item, tmp.checked); });
                        item.appendChild(tmp);
                        cbInput = tmp;
                    }
                    // 始终显示复选框（inline-flex 与我们的样式匹配）
                    const wrapper = item.querySelector('.select-checkbox') || (cbInput.parentElement && cbInput.parentElement.classList && cbInput.parentElement.classList.contains('select-checkbox') ? cbInput.parentElement : null);
                    if (wrapper) wrapper.style.display = 'inline-flex';
                    // 根据 selectedSet 恢复勾选状态和样式
                    const p = normalizePath(item.dataset.path || '');
                    if (selectedSet.has(p)) {
                        cbInput.checked = true;
                        item.classList.add('selected');
                    } else {
                        cbInput.checked = false;
                        item.classList.remove('selected');
                    }
                });
            } else {
                // 非选择模式，确保工具栏隐藏，复选框隐藏
                if (toolbar) toolbar.style.display = 'none';
                document.querySelectorAll('#file-list .file-item').forEach(item => {
                    const wrapper = item.querySelector('.select-checkbox');
                    if (wrapper) wrapper.style.display = 'inline-flex';
                    // 同步 input 的勾选状态为 false
                    const cbInput = item.querySelector('.custom-checkbox-input') || item.querySelector('input.select-checkbox');
                    if (cbInput) cbInput.checked = false;
                    item.classList.remove('selected');
                });
            }

            // 更新移动按钮状态（确保在文件列表刷新后根据当前路径/选择来源调整状态）
            updateMoveButtonState();
        };

        // 工具栏按钮
        document.addEventListener('click', (e) => {
            const el = e.target;
            if (el && el.id === 'select-cancel') exitSelectionMode();
            if (el && el.id === 'select-delete') batchDelete();
            // select-move will move to current folder (only enabled when navigated to a different folder)
            if (el && el.id === 'select-move') batchMoveToCurrentFolder();
        });

        // 批量删除（逐个调用后端删除接口）
        async function batchDelete() {
            if (!authToken) { showAuthModal(); return; }
            if (selectedSet.size === 0) return;
            const ok = confirm(`确认删除 ${selectedSet.size} 项？此操作不可撤销`);
            if (!ok) return;
            for (const p of Array.from(selectedSet)) {
                try {
                    const resp = await fetch('/api/cloud/delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password: authToken, path: p })
                    });
                    const data = await resp.json();
                    if (!data.success) showCloudResult(`删除 ${p} 失败: ${data.message}`, false);
                } catch (err) { showCloudResult(`删除 ${p} 失败: ${err.message}`, false); }
            }
            exitSelectionMode();
            loadCloudFiles();
        }

        // 批量移动到当前文件夹
        async function batchMoveToCurrentFolder() {
            if (!authToken) { showAuthModal(); return; }
            if (!selectionMode || selectedSet.size === 0) return;
            const target = normalizePath(currentCloudPath || '');
            // Prevent moving into same folder
            if (target === selectionOrigin) { showCloudResult('目标目录与源目录相同', false); return; }
            const paths = Array.from(selectedSet);
            try {
                const resp = await fetch('/api/cloud/move', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: authToken, items: paths, targetPath: target })
                });
                const data = await resp.json();
                if (data.success) {
                    showCloudResult(`移动成功: ${data.moved || 0} 项`, true);
                    exitSelectionMode();
                    loadCloudFiles();
                } else {
                    showCloudResult(`移动失败: ${data.message}`, false);
                }
            } catch (err) {
                showCloudResult(`移动失败: ${err.message}`, false);
            }
        }

            // 重命名模态框相关实现
            // 在页面底部动态插入模态框 HTML（避免在原始 DOM 中手动插入，兼容先前脚本读取）
            (function insertRenameModal() {
                if (document.getElementById('rename-modal')) return;
                const div = document.createElement('div');
                div.innerHTML = `
        <div id="rename-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm">
            <div class="bg-white dark:bg-dark-200 rounded-xl shadow-card dark:shadow-card-dark w-full max-w-md p-6 transform transition-all-300">
                <h2 class="text-xl font-bold mb-4">重命名</h2>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">输入新的文件或文件夹名称（不包含路径）</p>
                <input id="rename-input" class="input mb-4" type="text" placeholder="新名称">
                <div class="flex justify-end gap-3">
                    <button id="cancel-rename-btn" class="btn btn-outline">取消</button>
                    <button id="confirm-rename-btn" class="btn btn-primary">确定</button>
                </div>
                <input type="hidden" id="rename-old-path">
            </div>
        </div>
                `;
                document.body.appendChild(div);

                // 绑定元素引用
                elements.renameModal = document.getElementById('rename-modal');
                elements.renameInput = document.getElementById('rename-input');
                elements.confirmRenameBtn = document.getElementById('confirm-rename-btn');
                elements.cancelRenameBtn = document.getElementById('cancel-rename-btn');
                elements.renameOldPath = document.getElementById('rename-old-path');

                // 绑定事件
                elements.cancelRenameBtn.addEventListener('click', hideRenameModal);
                elements.confirmRenameBtn.addEventListener('click', renameItem);
                elements.renameInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') renameItem();
                });
            })();

            function showRenameModal(oldPath, displayName) {
                if (!authToken) { showAuthModal(); return; }
                elements.renameOldPath.value = oldPath;
                elements.renameInput.value = displayName || '';
                elements.renameModal.style.display = 'flex';
                elements.renameInput.focus();
                elements.renameInput.select();
            }

            function hideRenameModal() {
                if (elements.renameModal) elements.renameModal.style.display = 'none';
            }

            async function renameItem() {
                const oldPathRaw = elements.renameOldPath.value;
                const newNameRaw = elements.renameInput.value.trim();
                if (!oldPathRaw || !newNameRaw) return;

                // newName 不能包含路径分隔符
                if (newNameRaw.indexOf('/') !== -1 || newNameRaw.indexOf('\\') !== -1) {
                    showCloudResult('新名称不能包含路径分隔符', false);
                    return;
                }

                try {
                    const resp = await fetch('/api/cloud/rename', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password: authToken, path: oldPathRaw, newName: newNameRaw })
                    });
                    const data = await resp.json();
                    if (data.success) {
                        hideRenameModal();
                        showCloudResult('重命名成功', true);
                        // 如果被重命名的是当前目录本身，需要导航到新的父或更新路径
                        const normOld = normalizePath(currentCloudPath);
                        const normTarget = normalizePath(oldPathRaw);
                        if (normOld === normTarget) {
                            // 重命名当前目录本身，导航到父目录并尝试进入新的目录
                            const idx = normOld.lastIndexOf('/');
                            const parent = idx > 0 ? normOld.substring(0, idx) : '';
                            navigateToPath(parent);
                        } else {
                            // 其它情况刷新当前目录
                            loadCloudFiles();
                        }
                    } else {
                        showCloudResult(data.message || '重命名失败', false);
                    }
                } catch (err) {
                    showCloudResult(`重命名失败: ${err.message}`, false);
                }
            }
    </script>
</body>
</html>